
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="A powerful relational algebra CLI and library for JSONL data manipulation">
      
      
        <meta name="author" content="Alex Towell">
      
      
        <link rel="canonical" href="https://queelius.github.io/jsonl-algebra/reference/">
      
      
        <link rel="prev" href="..">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.17">
    
    
      
        <title>Reference - JSONL Algebra</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
      
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#api-reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="JSONL Algebra" class="md-header__button md-logo" aria-label="JSONL Algebra" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            JSONL Algebra
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reference
            
          </span>
        </div>
      </div>
    </div>
    
      
        <form class="md-header__option" data-md-component="palette">
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="default" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to dark mode"  type="radio" name="__palette" id="__palette_0">
    
      <label class="md-header__button md-icon" title="Switch to dark mode" for="__palette_1" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a4 4 0 0 0-4 4 4 4 0 0 0 4 4 4 4 0 0 0 4-4 4 4 0 0 0-4-4m0 10a6 6 0 0 1-6-6 6 6 0 0 1 6-6 6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
    
    
    
    <input class="md-option" data-md-color-media="" data-md-color-scheme="slate" data-md-color-primary="blue" data-md-color-accent="blue"  aria-label="Switch to light mode"  type="radio" name="__palette" id="__palette_1">
    
      <label class="md-header__button md-icon" title="Switch to light mode" for="__palette_0" hidden>
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 18c-.89 0-1.74-.2-2.5-.55C11.56 16.5 13 14.42 13 12s-1.44-4.5-3.5-5.45C10.26 6.2 11.11 6 12 6a6 6 0 0 1 6 6 6 6 0 0 1-6 6m8-9.31V4h-4.69L12 .69 8.69 4H4v4.69L.69 12 4 15.31V20h4.69L12 23.31 15.31 20H20v-4.69L23.31 12z"/></svg>
      </label>
    
  
</form>
      
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
          <a href="javascript:void(0)" class="md-search__icon md-icon" title="Share" aria-label="Share" data-clipboard data-clipboard-text="" data-md-component="search-share" tabindex="-1">
            
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M18 16.08c-.76 0-1.44.3-1.96.77L8.91 12.7c.05-.23.09-.46.09-.7s-.04-.47-.09-.7l7.05-4.11c.54.5 1.25.81 2.04.81a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3c0 .24.04.47.09.7L8.04 9.81C7.5 9.31 6.79 9 6 9a3 3 0 0 0-3 3 3 3 0 0 0 3 3c.79 0 1.5-.31 2.04-.81l7.12 4.15c-.05.21-.08.43-.08.66 0 1.61 1.31 2.91 2.92 2.91s2.92-1.3 2.92-2.91A2.92 2.92 0 0 0 18 16.08"/></svg>
          </a>
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/queelius/jsonl-algebra" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    queelius/jsonl-algebra
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    <li class="md-tabs__item md-tabs__item--active">
      <a href="./" class="md-tabs__link">
        
  
  
    
  
  Reference

      </a>
    </li>
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="JSONL Algebra" class="md-nav__button md-logo" aria-label="JSONL Algebra" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    JSONL Algebra
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/queelius/jsonl-algebra" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    queelius/jsonl-algebra
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ja.core" class="md-nav__link">
    <span class="md-ellipsis">
      core
    </span>
  </a>
  
    <nav class="md-nav" aria-label="core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.core.collect" class="md-nav__link">
    <span class="md-ellipsis">
      collect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.difference" class="md-nav__link">
    <span class="md-ellipsis">
      difference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.distinct" class="md-nav__link">
    <span class="md-ellipsis">
      distinct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.intersection" class="md-nav__link">
    <span class="md-ellipsis">
      intersection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.join" class="md-nav__link">
    <span class="md-ellipsis">
      join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.product" class="md-nav__link">
    <span class="md-ellipsis">
      product
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.project" class="md-nav__link">
    <span class="md-ellipsis">
      project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.rename" class="md-nav__link">
    <span class="md-ellipsis">
      rename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.select" class="md-nav__link">
    <span class="md-ellipsis">
      select
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.union" class="md-nav__link">
    <span class="md-ellipsis">
      union
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.cli" class="md-nav__link">
    <span class="md-ellipsis">
      cli
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cli">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.cli.handle_export_command_group" class="md-nav__link">
    <span class="md-ellipsis">
      handle_export_command_group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.cli.handle_import_command_group" class="md-nav__link">
    <span class="md-ellipsis">
      handle_import_command_group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.cli.json_error" class="md-nav__link">
    <span class="md-ellipsis">
      json_error
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.repl" class="md-nav__link">
    <span class="md-ellipsis">
      repl
    </span>
  </a>
  
    <nav class="md-nav" aria-label="repl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler" class="md-nav__link">
    <span class="md-ellipsis">
      ReplCompiler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReplCompiler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.add_to_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      add_to_pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_agg" class="md-nav__link">
    <span class="md-ellipsis">
      handle_agg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_compile" class="md-nav__link">
    <span class="md-ellipsis">
      handle_compile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_difference" class="md-nav__link">
    <span class="md-ellipsis">
      handle_difference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_distinct" class="md-nav__link">
    <span class="md-ellipsis">
      handle_distinct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_execute" class="md-nav__link">
    <span class="md-ellipsis">
      handle_execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_from" class="md-nav__link">
    <span class="md-ellipsis">
      handle_from
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_groupby" class="md-nav__link">
    <span class="md-ellipsis">
      handle_groupby
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_help" class="md-nav__link">
    <span class="md-ellipsis">
      handle_help
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_intersection" class="md-nav__link">
    <span class="md-ellipsis">
      handle_intersection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_join" class="md-nav__link">
    <span class="md-ellipsis">
      handle_join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_pipeline_show" class="md-nav__link">
    <span class="md-ellipsis">
      handle_pipeline_show
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_product" class="md-nav__link">
    <span class="md-ellipsis">
      handle_product
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_project" class="md-nav__link">
    <span class="md-ellipsis">
      handle_project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_rename" class="md-nav__link">
    <span class="md-ellipsis">
      handle_rename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_reset" class="md-nav__link">
    <span class="md-ellipsis">
      handle_reset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_select" class="md-nav__link">
    <span class="md-ellipsis">
      handle_select
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_sort" class="md-nav__link">
    <span class="md-ellipsis">
      handle_sort
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_union" class="md-nav__link">
    <span class="md-ellipsis">
      handle_union
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.parse_command" class="md-nav__link">
    <span class="md-ellipsis">
      parse_command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.process" class="md-nav__link">
    <span class="md-ellipsis">
      process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.repl" class="md-nav__link">
    <span class="md-ellipsis">
      repl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.commands" class="md-nav__link">
    <span class="md-ellipsis">
      commands
    </span>
  </a>
  
    <nav class="md-nav" aria-label="commands">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.commands.get_input_stream" class="md-nav__link">
    <span class="md-ellipsis">
      get_input_stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_agg" class="md-nav__link">
    <span class="md-ellipsis">
      handle_agg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_collect" class="md-nav__link">
    <span class="md-ellipsis">
      handle_collect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_difference" class="md-nav__link">
    <span class="md-ellipsis">
      handle_difference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_distinct" class="md-nav__link">
    <span class="md-ellipsis">
      handle_distinct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_explode" class="md-nav__link">
    <span class="md-ellipsis">
      handle_explode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_groupby" class="md-nav__link">
    <span class="md-ellipsis">
      handle_groupby
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_implode" class="md-nav__link">
    <span class="md-ellipsis">
      handle_implode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_import_csv" class="md-nav__link">
    <span class="md-ellipsis">
      handle_import_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_intersection" class="md-nav__link">
    <span class="md-ellipsis">
      handle_intersection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_join" class="md-nav__link">
    <span class="md-ellipsis">
      handle_join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_product" class="md-nav__link">
    <span class="md-ellipsis">
      handle_product
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_project" class="md-nav__link">
    <span class="md-ellipsis">
      handle_project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_rename" class="md-nav__link">
    <span class="md-ellipsis">
      handle_rename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_schema_infer" class="md-nav__link">
    <span class="md-ellipsis">
      handle_schema_infer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_schema_validate" class="md-nav__link">
    <span class="md-ellipsis">
      handle_schema_validate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_select" class="md-nav__link">
    <span class="md-ellipsis">
      handle_select
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_sort" class="md-nav__link">
    <span class="md-ellipsis">
      handle_sort
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_to_array" class="md-nav__link">
    <span class="md-ellipsis">
      handle_to_array
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_to_csv" class="md-nav__link">
    <span class="md-ellipsis">
      handle_to_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_to_jsonl" class="md-nav__link">
    <span class="md-ellipsis">
      handle_to_jsonl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_union" class="md-nav__link">
    <span class="md-ellipsis">
      handle_union
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.json_error" class="md-nav__link">
    <span class="md-ellipsis">
      json_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.read_jsonl" class="md-nav__link">
    <span class="md-ellipsis">
      read_jsonl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.write_json_object" class="md-nav__link">
    <span class="md-ellipsis">
      write_json_object
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.write_jsonl" class="md-nav__link">
    <span class="md-ellipsis">
      write_jsonl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.group" class="md-nav__link">
    <span class="md-ellipsis">
      group
    </span>
  </a>
  
    <nav class="md-nav" aria-label="group">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.group.groupby_agg" class="md-nav__link">
    <span class="md-ellipsis">
      groupby_agg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.group.groupby_chained" class="md-nav__link">
    <span class="md-ellipsis">
      groupby_chained
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.group.groupby_with_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      groupby_with_metadata
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.agg" class="md-nav__link">
    <span class="md-ellipsis">
      agg
    </span>
  </a>
  
    <nav class="md-nav" aria-label="agg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.agg.aggregate_grouped_data" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_grouped_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.agg.aggregate_single_group" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_single_group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.agg.apply_single_agg" class="md-nav__link">
    <span class="md-ellipsis">
      apply_single_agg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.agg.parse_agg_specs" class="md-nav__link">
    <span class="md-ellipsis">
      parse_agg_specs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.export" class="md-nav__link">
    <span class="md-ellipsis">
      export
    </span>
  </a>
  
    <nav class="md-nav" aria-label="export">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.export.dir_to_jsonl" class="md-nav__link">
    <span class="md-ellipsis">
      dir_to_jsonl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.export.json_array_to_jsonl_lines" class="md-nav__link">
    <span class="md-ellipsis">
      json_array_to_jsonl_lines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.export.jsonl_to_dir" class="md-nav__link">
    <span class="md-ellipsis">
      jsonl_to_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.export.jsonl_to_json_array_string" class="md-nav__link">
    <span class="md-ellipsis">
      jsonl_to_json_array_string
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.exporter" class="md-nav__link">
    <span class="md-ellipsis">
      exporter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="exporter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.exporter.jsonl_to_csv_stream" class="md-nav__link">
    <span class="md-ellipsis">
      jsonl_to_csv_stream
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.importer" class="md-nav__link">
    <span class="md-ellipsis">
      importer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="importer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.importer.csv_to_jsonl_lines" class="md-nav__link">
    <span class="md-ellipsis">
      csv_to_jsonl_lines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.importer.dir_to_jsonl_lines" class="md-nav__link">
    <span class="md-ellipsis">
      dir_to_jsonl_lines
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.schema" class="md-nav__link">
    <span class="md-ellipsis">
      schema
    </span>
  </a>
  
    <nav class="md-nav" aria-label="schema">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.schema.add_required_fields" class="md-nav__link">
    <span class="md-ellipsis">
      add_required_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.schema.get_json_type" class="md-nav__link">
    <span class="md-ellipsis">
      get_json_type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.schema.infer_schema" class="md-nav__link">
    <span class="md-ellipsis">
      infer_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.schema.infer_value_schema" class="md-nav__link">
    <span class="md-ellipsis">
      infer_value_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.schema.merge_schemas" class="md-nav__link">
    <span class="md-ellipsis">
      merge_schemas
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.expr" class="md-nav__link">
    <span class="md-ellipsis">
      expr
    </span>
  </a>
  
    <nav class="md-nav" aria-label="expr">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval" class="md-nav__link">
    <span class="md-ellipsis">
      ExprEval
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExprEval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.evaluate_arithmetic" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_arithmetic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.evaluate_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_comparison
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.get_field_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_field_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.parse_value" class="md-nav__link">
    <span class="md-ellipsis">
      parse_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.set_field_value" class="md-nav__link">
    <span class="md-ellipsis">
      set_field_value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#ja.core" class="md-nav__link">
    <span class="md-ellipsis">
      core
    </span>
  </a>
  
    <nav class="md-nav" aria-label="core">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.core.collect" class="md-nav__link">
    <span class="md-ellipsis">
      collect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.difference" class="md-nav__link">
    <span class="md-ellipsis">
      difference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.distinct" class="md-nav__link">
    <span class="md-ellipsis">
      distinct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.intersection" class="md-nav__link">
    <span class="md-ellipsis">
      intersection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.join" class="md-nav__link">
    <span class="md-ellipsis">
      join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.product" class="md-nav__link">
    <span class="md-ellipsis">
      product
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.project" class="md-nav__link">
    <span class="md-ellipsis">
      project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.rename" class="md-nav__link">
    <span class="md-ellipsis">
      rename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.select" class="md-nav__link">
    <span class="md-ellipsis">
      select
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.core.union" class="md-nav__link">
    <span class="md-ellipsis">
      union
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.cli" class="md-nav__link">
    <span class="md-ellipsis">
      cli
    </span>
  </a>
  
    <nav class="md-nav" aria-label="cli">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.cli.handle_export_command_group" class="md-nav__link">
    <span class="md-ellipsis">
      handle_export_command_group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.cli.handle_import_command_group" class="md-nav__link">
    <span class="md-ellipsis">
      handle_import_command_group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.cli.json_error" class="md-nav__link">
    <span class="md-ellipsis">
      json_error
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.repl" class="md-nav__link">
    <span class="md-ellipsis">
      repl
    </span>
  </a>
  
    <nav class="md-nav" aria-label="repl">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler" class="md-nav__link">
    <span class="md-ellipsis">
      ReplCompiler
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ReplCompiler">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.__init__" class="md-nav__link">
    <span class="md-ellipsis">
      __init__
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.add_to_pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      add_to_pipeline
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_agg" class="md-nav__link">
    <span class="md-ellipsis">
      handle_agg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_compile" class="md-nav__link">
    <span class="md-ellipsis">
      handle_compile
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_difference" class="md-nav__link">
    <span class="md-ellipsis">
      handle_difference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_distinct" class="md-nav__link">
    <span class="md-ellipsis">
      handle_distinct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_execute" class="md-nav__link">
    <span class="md-ellipsis">
      handle_execute
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_from" class="md-nav__link">
    <span class="md-ellipsis">
      handle_from
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_groupby" class="md-nav__link">
    <span class="md-ellipsis">
      handle_groupby
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_help" class="md-nav__link">
    <span class="md-ellipsis">
      handle_help
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_intersection" class="md-nav__link">
    <span class="md-ellipsis">
      handle_intersection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_join" class="md-nav__link">
    <span class="md-ellipsis">
      handle_join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_pipeline_show" class="md-nav__link">
    <span class="md-ellipsis">
      handle_pipeline_show
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_product" class="md-nav__link">
    <span class="md-ellipsis">
      handle_product
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_project" class="md-nav__link">
    <span class="md-ellipsis">
      handle_project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_rename" class="md-nav__link">
    <span class="md-ellipsis">
      handle_rename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_reset" class="md-nav__link">
    <span class="md-ellipsis">
      handle_reset
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_select" class="md-nav__link">
    <span class="md-ellipsis">
      handle_select
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_sort" class="md-nav__link">
    <span class="md-ellipsis">
      handle_sort
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.handle_union" class="md-nav__link">
    <span class="md-ellipsis">
      handle_union
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.parse_command" class="md-nav__link">
    <span class="md-ellipsis">
      parse_command
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.process" class="md-nav__link">
    <span class="md-ellipsis">
      process
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.ReplCompiler.run" class="md-nav__link">
    <span class="md-ellipsis">
      run
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.repl.repl" class="md-nav__link">
    <span class="md-ellipsis">
      repl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.commands" class="md-nav__link">
    <span class="md-ellipsis">
      commands
    </span>
  </a>
  
    <nav class="md-nav" aria-label="commands">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.commands.get_input_stream" class="md-nav__link">
    <span class="md-ellipsis">
      get_input_stream
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_agg" class="md-nav__link">
    <span class="md-ellipsis">
      handle_agg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_collect" class="md-nav__link">
    <span class="md-ellipsis">
      handle_collect
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_difference" class="md-nav__link">
    <span class="md-ellipsis">
      handle_difference
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_distinct" class="md-nav__link">
    <span class="md-ellipsis">
      handle_distinct
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_explode" class="md-nav__link">
    <span class="md-ellipsis">
      handle_explode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_groupby" class="md-nav__link">
    <span class="md-ellipsis">
      handle_groupby
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_implode" class="md-nav__link">
    <span class="md-ellipsis">
      handle_implode
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_import_csv" class="md-nav__link">
    <span class="md-ellipsis">
      handle_import_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_intersection" class="md-nav__link">
    <span class="md-ellipsis">
      handle_intersection
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_join" class="md-nav__link">
    <span class="md-ellipsis">
      handle_join
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_product" class="md-nav__link">
    <span class="md-ellipsis">
      handle_product
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_project" class="md-nav__link">
    <span class="md-ellipsis">
      handle_project
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_rename" class="md-nav__link">
    <span class="md-ellipsis">
      handle_rename
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_schema_infer" class="md-nav__link">
    <span class="md-ellipsis">
      handle_schema_infer
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_schema_validate" class="md-nav__link">
    <span class="md-ellipsis">
      handle_schema_validate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_select" class="md-nav__link">
    <span class="md-ellipsis">
      handle_select
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_sort" class="md-nav__link">
    <span class="md-ellipsis">
      handle_sort
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_to_array" class="md-nav__link">
    <span class="md-ellipsis">
      handle_to_array
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_to_csv" class="md-nav__link">
    <span class="md-ellipsis">
      handle_to_csv
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_to_jsonl" class="md-nav__link">
    <span class="md-ellipsis">
      handle_to_jsonl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.handle_union" class="md-nav__link">
    <span class="md-ellipsis">
      handle_union
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.json_error" class="md-nav__link">
    <span class="md-ellipsis">
      json_error
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.read_jsonl" class="md-nav__link">
    <span class="md-ellipsis">
      read_jsonl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.write_json_object" class="md-nav__link">
    <span class="md-ellipsis">
      write_json_object
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.commands.write_jsonl" class="md-nav__link">
    <span class="md-ellipsis">
      write_jsonl
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.group" class="md-nav__link">
    <span class="md-ellipsis">
      group
    </span>
  </a>
  
    <nav class="md-nav" aria-label="group">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.group.groupby_agg" class="md-nav__link">
    <span class="md-ellipsis">
      groupby_agg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.group.groupby_chained" class="md-nav__link">
    <span class="md-ellipsis">
      groupby_chained
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.group.groupby_with_metadata" class="md-nav__link">
    <span class="md-ellipsis">
      groupby_with_metadata
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.agg" class="md-nav__link">
    <span class="md-ellipsis">
      agg
    </span>
  </a>
  
    <nav class="md-nav" aria-label="agg">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.agg.aggregate_grouped_data" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_grouped_data
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.agg.aggregate_single_group" class="md-nav__link">
    <span class="md-ellipsis">
      aggregate_single_group
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.agg.apply_single_agg" class="md-nav__link">
    <span class="md-ellipsis">
      apply_single_agg
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.agg.parse_agg_specs" class="md-nav__link">
    <span class="md-ellipsis">
      parse_agg_specs
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.export" class="md-nav__link">
    <span class="md-ellipsis">
      export
    </span>
  </a>
  
    <nav class="md-nav" aria-label="export">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.export.dir_to_jsonl" class="md-nav__link">
    <span class="md-ellipsis">
      dir_to_jsonl
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.export.json_array_to_jsonl_lines" class="md-nav__link">
    <span class="md-ellipsis">
      json_array_to_jsonl_lines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.export.jsonl_to_dir" class="md-nav__link">
    <span class="md-ellipsis">
      jsonl_to_dir
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.export.jsonl_to_json_array_string" class="md-nav__link">
    <span class="md-ellipsis">
      jsonl_to_json_array_string
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.exporter" class="md-nav__link">
    <span class="md-ellipsis">
      exporter
    </span>
  </a>
  
    <nav class="md-nav" aria-label="exporter">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.exporter.jsonl_to_csv_stream" class="md-nav__link">
    <span class="md-ellipsis">
      jsonl_to_csv_stream
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.importer" class="md-nav__link">
    <span class="md-ellipsis">
      importer
    </span>
  </a>
  
    <nav class="md-nav" aria-label="importer">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.importer.csv_to_jsonl_lines" class="md-nav__link">
    <span class="md-ellipsis">
      csv_to_jsonl_lines
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.importer.dir_to_jsonl_lines" class="md-nav__link">
    <span class="md-ellipsis">
      dir_to_jsonl_lines
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.schema" class="md-nav__link">
    <span class="md-ellipsis">
      schema
    </span>
  </a>
  
    <nav class="md-nav" aria-label="schema">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.schema.add_required_fields" class="md-nav__link">
    <span class="md-ellipsis">
      add_required_fields
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.schema.get_json_type" class="md-nav__link">
    <span class="md-ellipsis">
      get_json_type
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.schema.infer_schema" class="md-nav__link">
    <span class="md-ellipsis">
      infer_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.schema.infer_value_schema" class="md-nav__link">
    <span class="md-ellipsis">
      infer_value_schema
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.schema.merge_schemas" class="md-nav__link">
    <span class="md-ellipsis">
      merge_schemas
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ja.expr" class="md-nav__link">
    <span class="md-ellipsis">
      expr
    </span>
  </a>
  
    <nav class="md-nav" aria-label="expr">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval" class="md-nav__link">
    <span class="md-ellipsis">
      ExprEval
    </span>
  </a>
  
    <nav class="md-nav" aria-label="ExprEval">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.evaluate" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.evaluate_arithmetic" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_arithmetic
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.evaluate_comparison" class="md-nav__link">
    <span class="md-ellipsis">
      evaluate_comparison
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.get_field_value" class="md-nav__link">
    <span class="md-ellipsis">
      get_field_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.parse_value" class="md-nav__link">
    <span class="md-ellipsis">
      parse_value
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#ja.expr.ExprEval.set_field_value" class="md-nav__link">
    <span class="md-ellipsis">
      set_field_value
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="api-reference">API Reference</h1>
<p>Welcome to the complete API reference for JSONL Algebra. Every function and class is listed here with its full documentation.</p>


<div class="doc doc-object doc-module">



<h2 id="ja.core" class="doc doc-heading">
            <code>ja.core</code>


</h2>

    <div class="doc doc-contents first">

        <p>Core relational operations for the JSONL algebra system.</p>
<p>This module implements the fundamental set and relational operations that form
the algebra for manipulating collections of JSON objects. All operations are
designed to work with lists of dictionaries, making them suitable for processing
JSONL data.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.core.collect" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">collect</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Collect metadata-grouped rows into actual groups.</p>
<p>This function takes rows with _groups metadata (from groupby operations)
and collects them into explicit groups. Each output row represents one
group with all its members in a _rows array.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries with _groups metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List where each dict represents a group with _rows array</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>Input:
[
    {"id": 1, "region": "North", "_groups": [{"field": "region", "value": "North"}]},
    {"id": 2, "region": "North", "_groups": [{"field": "region", "value": "North"}]},
    {"id": 3, "region": "South", "_groups": [{"field": "region", "value": "South"}]}
]</p>
<p>Output:
[
    {"region": "North", "_rows": [{"id": 1, "region": "North"}, {"id": 2, "region": "North"}]},
    {"region": "South", "_rows": [{"id": 3, "region": "South"}]}
]</p>
</details>

            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">collect</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Collect metadata-grouped rows into actual groups.</span>

<span class="sd">    This function takes rows with _groups metadata (from groupby operations)</span>
<span class="sd">    and collects them into explicit groups. Each output row represents one</span>
<span class="sd">    group with all its members in a _rows array.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries with _groups metadata</span>

<span class="sd">    Returns:</span>
<span class="sd">        List where each dict represents a group with _rows array</span>

<span class="sd">    Example:</span>
<span class="sd">        Input:</span>
<span class="sd">        [</span>
<span class="sd">            {&quot;id&quot;: 1, &quot;region&quot;: &quot;North&quot;, &quot;_groups&quot;: [{&quot;field&quot;: &quot;region&quot;, &quot;value&quot;: &quot;North&quot;}]},</span>
<span class="sd">            {&quot;id&quot;: 2, &quot;region&quot;: &quot;North&quot;, &quot;_groups&quot;: [{&quot;field&quot;: &quot;region&quot;, &quot;value&quot;: &quot;North&quot;}]},</span>
<span class="sd">            {&quot;id&quot;: 3, &quot;region&quot;: &quot;South&quot;, &quot;_groups&quot;: [{&quot;field&quot;: &quot;region&quot;, &quot;value&quot;: &quot;South&quot;}]}</span>
<span class="sd">        ]</span>

<span class="sd">        Output:</span>
<span class="sd">        [</span>
<span class="sd">            {&quot;region&quot;: &quot;North&quot;, &quot;_rows&quot;: [{&quot;id&quot;: 1, &quot;region&quot;: &quot;North&quot;}, {&quot;id&quot;: 2, &quot;region&quot;: &quot;North&quot;}]},</span>
<span class="sd">            {&quot;region&quot;: &quot;South&quot;, &quot;_rows&quot;: [{&quot;id&quot;: 3, &quot;region&quot;: &quot;South&quot;}]}</span>
<span class="sd">        ]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Check if data has grouping metadata</span>
    <span class="k">if</span> <span class="s2">&quot;_groups&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># No grouping metadata - treat entire dataset as one group</span>
        <span class="k">return</span> <span class="p">[{</span><span class="s2">&quot;_rows&quot;</span><span class="p">:</span> <span class="n">data</span><span class="p">}]</span>

    <span class="c1"># Collect rows by their group keys</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="c1"># Build group key from metadata</span>
        <span class="n">group_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">row</span><span class="p">[</span><span class="s2">&quot;_groups&quot;</span><span class="p">])</span>

        <span class="c1"># Create clean row without metadata</span>
        <span class="n">clean_row</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)}</span>

        <span class="n">groups</span><span class="p">[</span><span class="n">group_key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_row</span><span class="p">)</span>

    <span class="c1"># Build output with one row per group</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">group_dict</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Add group fields to output</span>
        <span class="k">for</span> <span class="n">field</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">group_key</span><span class="p">:</span>
            <span class="n">group_dict</span><span class="p">[</span><span class="n">field</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>

        <span class="c1"># Add collected rows</span>
        <span class="n">group_dict</span><span class="p">[</span><span class="s2">&quot;_rows&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">group_dict</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.difference" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">difference</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the difference of two collections.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>left</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First collection</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second collection</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Elements in left but not in right</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">difference</span><span class="p">(</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Relation</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the difference of two collections.</span>

<span class="sd">    Args:</span>
<span class="sd">        left: First collection</span>
<span class="sd">        right: Second collection</span>

<span class="sd">    Returns:</span>
<span class="sd">        Elements in left but not in right</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert right to a set of tuples for efficient lookup</span>
    <span class="n">right_set</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">right</span><span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">left</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">right_set</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.distinct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">distinct</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Remove duplicate rows from a collection.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List with duplicates removed</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">distinct</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Remove duplicate rows from a collection.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries</span>

<span class="sd">    Returns:</span>
<span class="sd">        List with duplicates removed</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">seen</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="c1"># Convert to tuple for hashability</span>
        <span class="n">row_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span>
        <span class="k">if</span> <span class="n">row_tuple</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
            <span class="n">seen</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">row_tuple</span><span class="p">)</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.intersection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">intersection</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the intersection of two collections.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>left</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First collection</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second collection</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Intersection of the two collections</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">intersection</span><span class="p">(</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Relation</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the intersection of two collections.</span>

<span class="sd">    Args:</span>
<span class="sd">        left: First collection</span>
<span class="sd">        right: Second collection</span>

<span class="sd">    Returns:</span>
<span class="sd">        Intersection of the two collections</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Convert right to a set of tuples for efficient lookup</span>
    <span class="n">right_set</span> <span class="o">=</span> <span class="p">{</span><span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">right</span><span class="p">}</span>

    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">left</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()))</span> <span class="ow">in</span> <span class="n">right_set</span><span class="p">:</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.join" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">join</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">on</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Inner join with nested-key support.</p>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">join</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span>
         <span class="n">right</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span>
         <span class="n">on</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Inner join with nested-key support.&quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ExprEval</span><span class="p">()</span>

    <span class="c1"># index right side</span>
    <span class="n">right_index</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="n">Any</span><span class="p">,</span> <span class="o">...</span><span class="p">],</span> <span class="n">List</span><span class="p">[</span><span class="n">Row</span><span class="p">]]</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">right</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">rk</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">rk</span> <span class="ow">in</span> <span class="n">on</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">key</span><span class="p">):</span>
            <span class="n">right_index</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">r</span><span class="p">)</span>

    <span class="c1"># roots of every RHS join path (e.g. &#39;user.id&#39; → &#39;user&#39;)</span>
    <span class="n">rhs_roots</span> <span class="o">=</span> <span class="p">{</span><span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;[.\[]&quot;</span><span class="p">,</span> <span class="n">rk</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">rk</span> <span class="ow">in</span> <span class="n">on</span><span class="p">}</span>

    <span class="n">joined</span><span class="p">:</span> <span class="n">Relation</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">left</span><span class="p">:</span>
        <span class="n">l_key</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">l</span><span class="p">,</span> <span class="n">lk</span><span class="p">)</span> <span class="k">for</span> <span class="n">lk</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">on</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">(</span><span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">l_key</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">right_index</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">l_key</span><span class="p">,</span> <span class="p">[]):</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">r</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">merged</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">l</span><span class="p">)</span>          <span class="c1"># left wins</span>
            <span class="c1"># drop right-side join columns</span>
            <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">rhs_roots</span><span class="p">:</span>
                <span class="n">merged</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">joined</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">joined</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.product" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">product</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Cartesian product; colliding keys from <em>right</em> are prefixed with <code>b_</code>.</p>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">product</span><span class="p">(</span><span class="n">left</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Relation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Cartesian product; colliding keys from *right* are prefixed with ``b_``.&quot;&quot;&quot;</span>
    <span class="n">result</span><span class="p">:</span> <span class="n">Relation</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">left</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">right</span><span class="p">:</span>
            <span class="n">merged</span> <span class="o">=</span> <span class="n">l</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">r</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">merged</span><span class="p">:</span>
                    <span class="n">merged</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;b_</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">merged</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">merged</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.project" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">project</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">fields</span><span class="p">,</span> <span class="n">use_jmespath</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Project specific fields from each row.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries to project</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>fields</code>
            </td>
            <td>
                  <code><span title="typing.List">List</span>[<span title="str">str</span>] | <span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Comma-separated field names or expressions</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_jmespath</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, use JMESPath for projection</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries with only the specified fields</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">project</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">fields</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">|</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_jmespath</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Project specific fields from each row.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries to project</span>
<span class="sd">        fields: Comma-separated field names or expressions</span>
<span class="sd">        use_jmespath: If True, use JMESPath for projection</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of dictionaries with only the specified fields</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">use_jmespath</span><span class="p">:</span>
        <span class="n">compiled_expr</span> <span class="o">=</span> <span class="n">jmespath</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">fields</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">compiled_expr</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">]</span>

    <span class="c1"># Parse field specifications</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ExprEval</span><span class="p">()</span>
    <span class="n">field_specs</span> <span class="o">=</span> <span class="n">fields</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">fields</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">fields</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">field_specs</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">spec</span><span class="p">:</span>
                <span class="c1"># Computed field: &quot;total=amount*1.1&quot; or &quot;is_adult=age&gt;=18&quot;</span>
                <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c1"># Check if it&#39;s an arithmetic expression</span>
                <span class="n">arith_result</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">evaluate_arithmetic</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">arith_result</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">new_row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">arith_result</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># Try as boolean expression</span>
                    <span class="n">new_row</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Simple field projection</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="c1"># Build nested structure</span>
                    <span class="n">parser</span><span class="o">.</span><span class="n">set_field_value</span><span class="p">(</span><span class="n">new_row</span><span class="p">,</span> <span class="n">spec</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.rename" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">rename</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Rename fields in each row.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>mapping</code>
            </td>
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary mapping old names to new names</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List with renamed fields</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rename</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">mapping</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Rename fields in each row.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries</span>
<span class="sd">        mapping: Dictionary mapping old names to new names</span>

<span class="sd">    Returns:</span>
<span class="sd">        List with renamed fields</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">new_row</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">new_key</span> <span class="o">=</span> <span class="n">mapping</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span>
            <span class="n">new_row</span><span class="p">[</span><span class="n">new_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">value</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.select" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">select</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">use_jmespath</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Filter rows based on an expression.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries to filter</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>expr</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Expression to evaluate (simple expression or JMESPath)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>use_jmespath</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, use JMESPath evaluation</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of rows where the expression evaluates to true</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">select</span><span class="p">(</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">use_jmespath</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Filter rows based on an expression.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries to filter</span>
<span class="sd">        expr: Expression to evaluate (simple expression or JMESPath)</span>
<span class="sd">        use_jmespath: If True, use JMESPath evaluation</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of rows where the expression evaluates to true</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">use_jmespath</span><span class="p">:</span>
        <span class="n">compiled_expr</span> <span class="o">=</span> <span class="n">jmespath</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">compiled_expr</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">row</span><span class="p">)]</span>

    <span class="c1"># Use simple expression parser</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ExprEval</span><span class="p">()</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># Handle &#39;and&#39; at the command level for simplicity</span>
    <span class="k">if</span> <span class="s2">&quot; and &quot;</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
        <span class="c1"># Multiple conditions with &#39;and&#39;</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; and &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">all</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot; or &quot;</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
        <span class="c1"># Multiple conditions with &#39;or&#39;</span>
        <span class="n">conditions</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; or &quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="n">parser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">cond</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">row</span><span class="p">)</span> <span class="k">for</span> <span class="n">cond</span> <span class="ow">in</span> <span class="n">conditions</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Single condition</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">parser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">row</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.core.union" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">union</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Compute the union of two collections.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>left</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First collection</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>right</code>
            </td>
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second collection</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.core.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Union of the two collections</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/core.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">union</span><span class="p">(</span>
    <span class="n">left</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Relation</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compute the union of two collections.</span>

<span class="sd">    Args:</span>
<span class="sd">        left: First collection</span>
<span class="sd">        right: Second collection</span>

<span class="sd">    Returns:</span>
<span class="sd">        Union of the two collections</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">left</span> <span class="o">+</span> <span class="n">right</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.cli" class="doc doc-heading">
            <code>ja.cli</code>


</h2>

    <div class="doc doc-contents first">

        <p>Command-line interface for JSONL algebra operations.</p>
<p>This module provides the main CLI entry point and argument parsing for
all JSONL algebra operations including relational algebra, schema inference,
data import/export, and interactive REPL mode.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.cli.handle_export_command_group" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_export_command_group</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle export subcommands by delegating to appropriate handlers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parsed command line arguments with export_cmd attribute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/cli.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_export_command_group</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle export subcommands by delegating to appropriate handlers.</span>

<span class="sd">    Args:</span>
<span class="sd">        args: Parsed command line arguments with export_cmd attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">export_command_handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;array&quot;</span><span class="p">:</span> <span class="n">handle_to_array</span><span class="p">,</span>
        <span class="s2">&quot;jsonl&quot;</span><span class="p">:</span> <span class="n">handle_to_jsonl</span><span class="p">,</span>
        <span class="s2">&quot;explode&quot;</span><span class="p">:</span> <span class="n">handle_explode</span><span class="p">,</span>
        <span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="n">handle_to_csv</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">export_command_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">export_cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
        <span class="n">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This should not be reached if subcommands are handled correctly in main</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown export command: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">export_cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.cli.handle_import_command_group" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_import_command_group</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle import subcommands by delegating to appropriate handlers.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Parsed command line arguments with import_cmd attribute.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/cli.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_import_command_group</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle import subcommands by delegating to appropriate handlers.</span>

<span class="sd">    Args:</span>
<span class="sd">        args: Parsed command line arguments with import_cmd attribute.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">import_command_handlers</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;csv&quot;</span><span class="p">:</span> <span class="n">handle_import_csv</span><span class="p">,</span>
        <span class="s2">&quot;implode&quot;</span><span class="p">:</span> <span class="n">handle_implode</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="n">handler</span> <span class="o">=</span> <span class="n">import_command_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">import_cmd</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">handler</span><span class="p">:</span>
        <span class="n">handler</span><span class="p">(</span><span class="n">args</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># This should not be reached if subcommands are handled correctly in main</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown import command: </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">import_cmd</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.cli.json_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">json_error</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Output error in JSON format and exit.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>error_type</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Type of error (e.g., "ParseError", "IOError")</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>message</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Human-readable error message</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>details</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Optional dict with additional error details</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>exit_code</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Exit code (default: 1)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/cli.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">json_error</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">exit_code</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Output error in JSON format and exit.</span>

<span class="sd">    Args:</span>
<span class="sd">        error_type: Type of error (e.g., &quot;ParseError&quot;, &quot;IOError&quot;)</span>
<span class="sd">        message: Human-readable error message</span>
<span class="sd">        details: Optional dict with additional error details</span>
<span class="sd">        exit_code: Exit code (default: 1)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">error_obj</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">,</span> <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">}}</span>
    <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
        <span class="n">error_obj</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span>

    <span class="c1"># If stderr is not a tty (redirected/piped), always output JSON</span>
    <span class="c1"># If stderr is a tty, output human-readable unless JA_JSON_ERRORS is set</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">isatty</span><span class="p">()</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;JA_JSON_ERRORS&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">error_obj</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Human-readable format for terminal</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;ja: error: </span><span class="si">{</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">details</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">key</span> <span class="o">!=</span> <span class="s2">&quot;traceback&quot;</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">value</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="n">exit_code</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.repl" class="doc doc-heading">
            <code>ja.repl</code>


</h2>

    <div class="doc doc-contents first">

        <p>Interactive REPL (Read-Eval-Print Loop) for JSONL algebra operations.</p>
<p>This module provides a friendly, interactive shell for chaining JSONL algebra
operations together. It's a great way to explore your data, build up complex
transformation pipelines step-by-step, and see the results instantly.</p>
<p>Think of it as a command-line laboratory for your JSONL data!</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="ja.repl.ReplCompiler" class="doc doc-heading">
            <code>ReplCompiler</code>


</h3>


    <div class="doc doc-contents ">


        <p>Compiles and executes a sequence of JSONL algebra commands.</p>
<p>This class is the engine of the REPL. It manages the state of the command
pipeline, parses user input, and translates the pipeline into a shell command
that can be executed. It's designed to provide an intuitive, interactive
experience for building data workflows.</p>







              <details class="quote">
                <summary>Source code in <code>ja/repl.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ReplCompiler</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Compiles and executes a sequence of JSONL algebra commands.</span>

<span class="sd">    This class is the engine of the REPL. It manages the state of the command</span>
<span class="sd">    pipeline, parses user input, and translates the pipeline into a shell command</span>
<span class="sd">    that can be executed. It&#39;s designed to provide an intuitive, interactive</span>
<span class="sd">    experience for building data workflows.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Initialize the REPL compiler with an empty pipeline.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Can be a file path or None (implying stdin)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Command handlers are registered in the `run` method.</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a line of input into a command and its arguments.</span>

<span class="sd">        Uses `shlex` to handle quoted arguments correctly.</span>

<span class="sd">        Args:</span>
<span class="sd">            line (str): The raw input line from the user.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple of (command, args_list), or (None, None) if parsing fails.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Check your quotes.&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="n">command</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
        <span class="n">args</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
        <span class="k">return</span> <span class="n">command</span><span class="p">,</span> <span class="n">args</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set the initial data source for the pipeline (e.g., a file).</span>

<span class="sd">        This command must be the first one used when starting a new pipeline</span>
<span class="sd">        with a file source.</span>

<span class="sd">        Args:</span>
<span class="sd">            args (list): A list containing the file path or &quot;stdin&quot;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;from&#39; requires a file path (or &#39;stdin&#39;).&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Error: &#39;from&#39; can only be used at the beginning of a new pipeline. Use &#39;reset&#39; first.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;stdin&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Internally, None means stdin for clarity</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input source set to: stdin&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input source set to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">add_to_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cli_command_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Add a new command step to the current pipeline.</span>

<span class="sd">        Args:</span>
<span class="sd">            command_name (str): The name of the REPL command (e.g., &quot;project&quot;).</span>
<span class="sd">            args (list): The list of arguments for the command.</span>
<span class="sd">            cli_command_name (str, optional): The corresponding `ja` CLI command name.</span>
<span class="sd">                                             Defaults to `command_name`.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">cli_command_name</span><span class="p">:</span>
            <span class="n">cli_command_name</span> <span class="o">=</span> <span class="n">command_name</span>
        <span class="c1"># Ensure &#39;from&#39; is not added to the pipeline steps directly</span>
        <span class="k">if</span> <span class="n">command_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Error: &#39;from&#39; is a directive, not a pipeline step. Use &#39;reset&#39; then &#39;from &lt;file&gt;&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;repl_command&quot;</span><span class="p">:</span> <span class="n">command_name</span><span class="p">,</span>
                <span class="s2">&quot;cli_command&quot;</span><span class="p">:</span> <span class="n">cli_command_name</span><span class="p">,</span>
                <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
            <span class="p">}</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added: </span><span class="si">{</span><span class="n">command_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;select&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;select&#39; requires an expression.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;select&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;project&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;project&#39; requires column names.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;join&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;--on&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;join&#39; requires &lt;right_file&gt; --on &lt;key_map&gt;.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: join orders.jsonl --on user.id=customer_id&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;join&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;rename&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;rename&#39; requires a mapping (e.g., old_name=new_name).&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;rename&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;distinct&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: &#39;distinct&#39; does not take arguments in REPL mode. Ignoring.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;distinct&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;sort&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;sort&#39; requires column names.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;groupby&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="c1"># Support both chained groupby (no --agg) and immediate aggregation (with --agg)</span>
        <span class="k">if</span> <span class="s2">&quot;--agg&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
            <span class="c1"># Traditional groupby with immediate aggregation</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;--agg&quot;</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;groupby --agg&#39; requires &lt;key&gt; --agg &lt;spec&gt;.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: groupby user.location --agg count,sum(amount)&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Chained groupby mode</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;groupby&#39; requires a key.&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: groupby region&quot;</span><span class="p">)</span>
                <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;groupby&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_agg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;agg&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;agg&#39; requires an aggregation specification.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: agg count,total=sum(amount)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;agg&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;product&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;product&#39; requires a right file path.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;product&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;union&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;union&#39; requires a file path.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;union&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;intersection&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;intersection&#39; requires a file path.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;intersection&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Handle the &#39;difference&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;difference&#39; requires a file path.&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;difference&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">_generate_pipeline_command_string_and_segments</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Construct the full shell command string from the pipeline steps.</span>

<span class="sd">        This is the core logic that translates the user&#39;s interactive steps into</span>
<span class="sd">        a runnable `ja ... | ja ...` shell command.</span>

<span class="sd">        Returns:</span>
<span class="sd">            A tuple containing:</span>
<span class="sd">            - The full, executable shell command string.</span>
<span class="sd">            - A list of individual command segments for display.</span>
<span class="sd">            - An error message string, if any.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;Pipeline is empty.&quot;</span>

        <span class="n">display_segments</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">execution_segments</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">):</span>
            <span class="n">current_ja_cmd_parts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;ja&quot;</span><span class="p">,</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;cli_command&quot;</span><span class="p">]]</span>
            <span class="n">is_first_command_in_pipe</span> <span class="o">=</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span>

            <span class="k">if</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;cli_command&quot;</span><span class="p">]</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;join&quot;</span><span class="p">,</span> <span class="s2">&quot;product&quot;</span><span class="p">,</span> <span class="s2">&quot;union&quot;</span><span class="p">,</span> <span class="s2">&quot;intersection&quot;</span><span class="p">,</span> <span class="s2">&quot;difference&quot;</span><span class="p">]:</span>
                <span class="c1"># REPL args: &lt;right_file&gt; [--on &lt;key_map&gt;] for join</span>
                <span class="c1"># REPL args: &lt;right_file&gt; for product</span>
                <span class="c1"># CLI: ja join &lt;left&gt; &lt;right&gt; --on &lt;key_map&gt;</span>
                <span class="c1"># CLI: ja product &lt;left&gt; &lt;right&gt;</span>
                <span class="n">right_file_repl_arg</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">is_first_command_in_pipe</span><span class="p">:</span>
                    <span class="n">left_input_for_cli</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">left_input_for_cli</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>

                <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">left_input_for_cli</span><span class="p">)</span>
                <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">right_file_repl_arg</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;cli_command&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;join&quot;</span><span class="p">:</span>
                    <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:])</span>  <span class="c1"># --on &lt;key_map&gt;</span>

            <span class="k">elif</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;cli_command&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;groupby&quot;</span><span class="p">:</span>
                <span class="c1"># REPL args: &lt;key&gt; [--agg &lt;spec&gt;]</span>
                <span class="c1"># CLI: ja groupby &lt;key&gt; &lt;file_or_stdin&gt; [--agg &lt;spec&gt;]</span>
                <span class="n">key_repl_arg</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">other_args</span> <span class="o">=</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">][</span><span class="mi">1</span><span class="p">:]</span>

                <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key_repl_arg</span><span class="p">)</span>

                <span class="k">if</span> <span class="n">is_first_command_in_pipe</span><span class="p">:</span>
                    <span class="n">input_file_for_cli</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="k">else</span> <span class="s2">&quot;-&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">input_file_for_cli</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
                <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">input_file_for_cli</span><span class="p">)</span>
                <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">other_args</span><span class="p">)</span>

            <span class="k">elif</span> <span class="n">step</span><span class="p">[</span><span class="s2">&quot;cli_command&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;agg&quot;</span><span class="p">:</span>
                <span class="c1"># REPL args: &lt;spec&gt;</span>
                <span class="c1"># CLI: ja agg &lt;spec&gt; [file_or_stdin]</span>
                <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">is_first_command_in_pipe</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="p">:</span>
                        <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="p">)</span>

            <span class="k">else</span><span class="p">:</span>  <span class="c1"># select, project, rename, distinct, sort</span>
                <span class="c1"># REPL args: &lt;command_specific_args&gt;</span>
                <span class="c1"># CLI: ja &lt;command&gt; [command_specific_args...] [file_if_first_and_not_stdin]</span>
                <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">step</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">])</span>

                <span class="k">if</span> <span class="n">is_first_command_in_pipe</span><span class="p">:</span>
                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="p">:</span>
                        <span class="n">current_ja_cmd_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="p">)</span>

            <span class="n">joined_segment</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">current_ja_cmd_parts</span><span class="p">)</span>
            <span class="n">display_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined_segment</span><span class="p">)</span>
            <span class="n">execution_segments</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">joined_segment</span><span class="p">)</span>

        <span class="n">executable_command_string</span> <span class="o">=</span> <span class="s2">&quot; | &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">execution_segments</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">executable_command_string</span><span class="p">,</span> <span class="n">display_segments</span><span class="p">,</span> <span class="kc">None</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Generate and print a bash script for the current pipeline.&quot;&quot;&quot;</span>
        <span class="n">_executable_cmd_str</span><span class="p">,</span> <span class="n">display_segments</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pipeline_command_string_and_segments</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Compiled Bash Script ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Generated by ja REPL&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">display_segments</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Pipeline is empty.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_segments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">display_segments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Build the pretty-printed pipeline string</span>
            <span class="n">script_str</span> <span class="o">=</span> <span class="n">display_segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_segments</span><span class="p">)):</span>
                <span class="n">script_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; | </span><span class="se">\\\n</span><span class="s2">  </span><span class="si">{</span><span class="n">display_segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">script_str</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Execute the current pipeline and display the output.&quot;&quot;&quot;</span>
        <span class="n">limit_lines</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">cmd_args</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--lines=&quot;</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">limit_lines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                    <span class="k">if</span> <span class="n">limit_lines</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: --lines must be a positive integer.&quot;</span><span class="p">)</span>
                        <span class="k">return</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="s2">&quot;Error: Invalid format for --lines. Use --lines=N (e.g., --lines=10).&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Warning: Unknown argument &#39;</span><span class="si">{</span><span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; for execute. Ignoring. Did you mean --lines=N?&quot;</span>
                <span class="p">)</span>

        <span class="n">command_to_execute</span><span class="p">,</span> <span class="n">_display_segments</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pipeline_command_string_and_segments</span><span class="p">()</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">command_to_execute</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Internal error: No command to execute.&quot;</span>
            <span class="p">)</span>  <span class="c1"># Should be caught by error_msg</span>
            <span class="k">return</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing: </span><span class="si">{</span><span class="n">command_to_execute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
                <span class="n">command_to_execute</span><span class="p">,</span>
                <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Essential for pipes</span>
                <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Manually check returncode</span>
            <span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Output ---&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
                <span class="n">output_lines_list</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">limit_lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line_content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_lines_list</span><span class="p">):</span>
                        <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit_lines</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span><span class="n">line_content</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="nb">print</span><span class="p">(</span>
                                <span class="sa">f</span><span class="s2">&quot;... (output truncated to </span><span class="si">{</span><span class="n">limit_lines</span><span class="si">}</span><span class="s2"> lines, total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output_lines_list</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                            <span class="p">)</span>
                            <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">elif</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(No output produced)&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Errors ---&quot;</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

            <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Command exited with status </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Execution successful: No output and no errors)&quot;</span><span class="p">)</span>

            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Command &#39;ja&#39; not found. Make sure it&#39;s in your PATH.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred while trying to execute the command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
            <span class="c1"># import traceback</span>
            <span class="c1"># traceback.print_exc()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Clear the current pipeline and reset the input source.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipeline reset.&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_pipeline_show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the steps in the current pipeline.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipeline is empty.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current pipeline:&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Input: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  Input: stdin (assumed for the first command if &#39;from&#39; not used)&quot;</span>
                <span class="p">)</span>
            <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;repl_command&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">handle_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Display the help message with all available REPL commands.&quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Welcome to the `ja` REPL! Build data pipelines interactively.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Here are the available commands:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  from &lt;file|stdin&gt;      : Start a new pipeline from a file or stdin.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: from users.jsonl&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  select &#39;&lt;expr&gt;&#39;        : Filter rows with a Python expression.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: select &#39;user.age &gt; 30&#39;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;  project &lt;cols&gt;         : Pick columns, supporting nested data with dot notation.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: project id,user.name,user.location&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  join &lt;file&gt; --on &lt;L=R&gt; : Join with another file on one or more keys.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: join orders.jsonl --on id=user_id&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  rename &lt;old=new,...&gt;   : Rename columns. Supports dot notation.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: rename user.id=user_id,location=loc&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  distinct               : Remove duplicate rows based on all columns.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;  sort &lt;cols&gt;            : Sort rows by one or more columns (supports dot notation).&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: sort user.age,id&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  groupby &lt;key&gt; --agg &lt;&gt; : Group rows and aggregate data.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;                           Example: groupby cat --agg count,avg:user.score&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;  product &lt;file&gt;         : Create a Cartesian product with another file.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: product features.jsonl&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  union &lt;file&gt;           : Combine rows from another file (deduplicated).&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: union archived_users.jsonl&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  intersection &lt;file&gt;    : Keep only rows present in another file.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: intersection active_users.jsonl&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  difference &lt;file&gt;      : Remove rows present in another file.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: difference temp_users.jsonl&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Pipeline Control ---&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;  execute [--lines=N]    : Run the pipeline and see output (e.g., execute --lines=10).&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;  compile                : Show the bash script for the current pipeline.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  pipeline               : Show the steps in the current pipeline.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  reset                  : Clear the current pipeline.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  help                   : Show this help message.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  exit                   : Exit the REPL.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tips:&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Use dot notation (e.g., `user.address.city`) for nested JSON fields.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;- Wrap arguments with spaces in quotes (e.g., select &#39;name == &quot;John Doe&quot;&#39;).\n&quot;&quot;&quot;</span>
        <span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Process a single line of input from the REPL.</span>

<span class="sd">        This method parses the line, finds the appropriate handler for the</span>
<span class="sd">        command, and invokes it.</span>

<span class="sd">        Args:</span>
<span class="sd">            line (str): The line of input to process.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">return</span>

            <span class="n">command</span><span class="p">,</span> <span class="n">cmd_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Parsing error</span>
                <span class="k">return</span>

            <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="n">cmd_args</span><span class="p">)</span>
            <span class="k">elif</span> <span class="n">command</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Unknown command: &#39;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&#39;. Type &#39;help&#39; for available commands.&quot;</span>
                <span class="p">)</span>

        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exiting...&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Interrupted. Use &#39;exit&#39; to quit.&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

            <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_command_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># Renamed &#39;args&#39; for clarity</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Start the main REPL event loop.</span>

<span class="sd">        This method prints a welcome message, registers all command handlers,</span>
<span class="sd">        and enters an infinite loop to read and process user input.</span>

<span class="sd">        Args:</span>
<span class="sd">            initial_command_list (list, optional): A list of command-line arguments</span>
<span class="sd">                                                   to process before starting the</span>
<span class="sd">                                                   interactive loop.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Welcome to ja REPL. Type &#39;help&#39; for commands, &#39;exit&#39; to quit.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># Assign to self.handlers so self.process() can use it</span>
            <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_from</span><span class="p">,</span>
            <span class="s2">&quot;select&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_select</span><span class="p">,</span>
            <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_project</span><span class="p">,</span>
            <span class="s2">&quot;join&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_join</span><span class="p">,</span>
            <span class="s2">&quot;rename&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_rename</span><span class="p">,</span>
            <span class="s2">&quot;distinct&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_distinct</span><span class="p">,</span>
            <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_sort</span><span class="p">,</span>
            <span class="s2">&quot;groupby&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_groupby</span><span class="p">,</span>
            <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_product</span><span class="p">,</span>
            <span class="s2">&quot;union&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_union</span><span class="p">,</span>
            <span class="s2">&quot;intersection&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_intersection</span><span class="p">,</span>
            <span class="s2">&quot;difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_difference</span><span class="p">,</span>
            <span class="s2">&quot;compile&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_compile</span><span class="p">,</span>
            <span class="s2">&quot;execute&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_execute</span><span class="p">,</span>
            <span class="s2">&quot;agg&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_agg</span><span class="p">,</span>
            <span class="s2">&quot;reset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_reset</span><span class="p">,</span>
            <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_pipeline_show</span><span class="p">,</span>
            <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_help</span><span class="p">,</span>
            <span class="s2">&quot;exit&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">_args</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
                <span class="mi">0</span>
            <span class="p">),</span>  <span class="c1"># Consistent signature with other handlers</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="n">initial_command_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_command_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">processed_initial_parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial_command_list</span><span class="p">)</span>
            <span class="c1"># If the first token of initial_command_list is not a known REPL command,</span>
            <span class="c1"># assume &#39;from&#39; should be prepended.</span>
            <span class="c1"># This allows `ja repl myfile.jsonl` to be treated as `from myfile.jsonl`.</span>
            <span class="k">if</span> <span class="n">processed_initial_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
                <span class="n">processed_initial_parts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="p">)</span>

            <span class="n">initial_line</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                <span class="n">processed_initial_parts</span>
            <span class="p">)</span>  <span class="c1"># Use shlex.join for safety</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">initial_line</span><span class="p">)</span>

        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;ja&gt; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                    <span class="k">continue</span>
                <span class="c1"># &#39;exit&#39; command will be handled by self.process -&gt; self.handlers[&#39;exit&#39;]</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exiting...&quot;</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Ensure clean exit</span>
            <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Interrupted. Type &#39;exit&#39; or Ctrl-D to quit.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.__init__" class="doc doc-heading">
            <code class="highlight language-python"><span class="fm">__init__</span><span class="p">()</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Initialize the REPL compiler with an empty pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Initialize the REPL compiler with an empty pipeline.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Can be a file path or None (implying stdin)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Command handlers are registered in the `run` method.</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.add_to_pipeline" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_to_pipeline</span><span class="p">(</span><span class="n">command_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cli_command_name</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Add a new command step to the current pipeline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>command_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The name of the REPL command (e.g., "project").</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The list of arguments for the command.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cli_command_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The corresponding <code>ja</code> CLI command name.
                             Defaults to <code>command_name</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_to_pipeline</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">command_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">cli_command_name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Add a new command step to the current pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        command_name (str): The name of the REPL command (e.g., &quot;project&quot;).</span>
<span class="sd">        args (list): The list of arguments for the command.</span>
<span class="sd">        cli_command_name (str, optional): The corresponding `ja` CLI command name.</span>
<span class="sd">                                         Defaults to `command_name`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">cli_command_name</span><span class="p">:</span>
        <span class="n">cli_command_name</span> <span class="o">=</span> <span class="n">command_name</span>
    <span class="c1"># Ensure &#39;from&#39; is not added to the pipeline steps directly</span>
    <span class="k">if</span> <span class="n">command_name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;from&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Error: &#39;from&#39; is a directive, not a pipeline step. Use &#39;reset&#39; then &#39;from &lt;file&gt;&#39;.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
        <span class="p">{</span>
            <span class="s2">&quot;repl_command&quot;</span><span class="p">:</span> <span class="n">command_name</span><span class="p">,</span>
            <span class="s2">&quot;cli_command&quot;</span><span class="p">:</span> <span class="n">cli_command_name</span><span class="p">,</span>
            <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">args</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Added: </span><span class="si">{</span><span class="n">command_name</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">args</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_agg" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_agg</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'agg' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_agg</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;agg&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;agg&#39; requires an aggregation specification.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: agg count,total=sum(amount)&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;agg&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_compile" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_compile</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Generate and print a bash script for the current pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_compile</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Generate and print a bash script for the current pipeline.&quot;&quot;&quot;</span>
    <span class="n">_executable_cmd_str</span><span class="p">,</span> <span class="n">display_segments</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pipeline_command_string_and_segments</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Compiled Bash Script ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;#!/bin/bash&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Generated by ja REPL&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">display_segments</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;# Pipeline is empty.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_segments</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">display_segments</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Build the pretty-printed pipeline string</span>
        <span class="n">script_str</span> <span class="o">=</span> <span class="n">display_segments</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">display_segments</span><span class="p">)):</span>
            <span class="n">script_str</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot; | </span><span class="se">\\\n</span><span class="s2">  </span><span class="si">{</span><span class="n">display_segments</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">script_str</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_difference" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_difference</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'difference' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_difference</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;difference&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;difference&#39; requires a file path.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;difference&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_distinct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_distinct</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'distinct' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_distinct</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;distinct&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: &#39;distinct&#39; does not take arguments in REPL mode. Ignoring.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;distinct&quot;</span><span class="p">,</span> <span class="p">[])</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_execute" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_execute</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Execute the current pipeline and display the output.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_execute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cmd_args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Execute the current pipeline and display the output.&quot;&quot;&quot;</span>
    <span class="n">limit_lines</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="n">cmd_args</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;--lines=&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">limit_lines</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
                <span class="k">if</span> <span class="n">limit_lines</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: --lines must be a positive integer.&quot;</span><span class="p">)</span>
                    <span class="k">return</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="s2">&quot;Error: Invalid format for --lines. Use --lines=N (e.g., --lines=10).&quot;</span>
                <span class="p">)</span>
                <span class="k">return</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: Unknown argument &#39;</span><span class="si">{</span><span class="n">cmd_args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; for execute. Ignoring. Did you mean --lines=N?&quot;</span>
            <span class="p">)</span>

    <span class="n">command_to_execute</span><span class="p">,</span> <span class="n">_display_segments</span><span class="p">,</span> <span class="n">error_msg</span> <span class="o">=</span> <span class="p">(</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_pipeline_command_string_and_segments</span><span class="p">()</span>
    <span class="p">)</span>

    <span class="k">if</span> <span class="n">error_msg</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">error_msg</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">command_to_execute</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Internal error: No command to execute.&quot;</span>
        <span class="p">)</span>  <span class="c1"># Should be caught by error_msg</span>
        <span class="k">return</span>

    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing: </span><span class="si">{</span><span class="n">command_to_execute</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">process</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="n">command_to_execute</span><span class="p">,</span>
            <span class="n">shell</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>  <span class="c1"># Essential for pipes</span>
            <span class="n">capture_output</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>  <span class="c1"># Manually check returncode</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Output ---&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="p">:</span>
            <span class="n">output_lines_list</span> <span class="o">=</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">limit_lines</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line_content</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">output_lines_list</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">limit_lines</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span><span class="n">line_content</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="nb">print</span><span class="p">(</span>
                            <span class="sa">f</span><span class="s2">&quot;... (output truncated to </span><span class="si">{</span><span class="n">limit_lines</span><span class="si">}</span><span class="s2"> lines, total </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">output_lines_list</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                        <span class="p">)</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
        <span class="k">elif</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(No output produced)&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Errors ---&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">process</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>

        <span class="k">if</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Command exited with status </span><span class="si">{</span><span class="n">process</span><span class="o">.</span><span class="n">returncode</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">process</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">and</span> <span class="n">process</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;(Execution successful: No output and no errors)&quot;</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;--------------</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">FileNotFoundError</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: Command &#39;ja&#39; not found. Make sure it&#39;s in your PATH.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># pragma: no cover</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred while trying to execute the command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_from" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_from</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set the initial data source for the pipeline (e.g., a file).</p>
<p>This command must be the first one used when starting a new pipeline
with a file source.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>args</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list containing the file path or "stdin".</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_from</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set the initial data source for the pipeline (e.g., a file).</span>

<span class="sd">    This command must be the first one used when starting a new pipeline</span>
<span class="sd">    with a file source.</span>

<span class="sd">    Args:</span>
<span class="sd">        args (list): A list containing the file path or &quot;stdin&quot;.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;from&#39; requires a file path (or &#39;stdin&#39;).&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Error: &#39;from&#39; can only be used at the beginning of a new pipeline. Use &#39;reset&#39; first.&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="o">=</span> <span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;stdin&quot;</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Internally, None means stdin for clarity</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Input source set to: stdin&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input source set to: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_groupby" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_groupby</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'groupby' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_groupby</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;groupby&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="c1"># Support both chained groupby (no --agg) and immediate aggregation (with --agg)</span>
    <span class="k">if</span> <span class="s2">&quot;--agg&quot;</span> <span class="ow">in</span> <span class="n">args</span><span class="p">:</span>
        <span class="c1"># Traditional groupby with immediate aggregation</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;--agg&quot;</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;groupby --agg&#39; requires &lt;key&gt; --agg &lt;spec&gt;.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: groupby user.location --agg count,sum(amount)&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Chained groupby mode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;groupby&#39; requires a key.&quot;</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: groupby region&quot;</span><span class="p">)</span>
            <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;groupby&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_help" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_help</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Display the help message with all available REPL commands.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_help</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the help message with all available REPL commands.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Welcome to the `ja` REPL! Build data pipelines interactively.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Here are the available commands:</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  from &lt;file|stdin&gt;      : Start a new pipeline from a file or stdin.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: from users.jsonl&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  select &#39;&lt;expr&gt;&#39;        : Filter rows with a Python expression.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: select &#39;user.age &gt; 30&#39;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;  project &lt;cols&gt;         : Pick columns, supporting nested data with dot notation.&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: project id,user.name,user.location&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  join &lt;file&gt; --on &lt;L=R&gt; : Join with another file on one or more keys.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: join orders.jsonl --on id=user_id&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  rename &lt;old=new,...&gt;   : Rename columns. Supports dot notation.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: rename user.id=user_id,location=loc&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  distinct               : Remove duplicate rows based on all columns.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;  sort &lt;cols&gt;            : Sort rows by one or more columns (supports dot notation).&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: sort user.age,id&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  groupby &lt;key&gt; --agg &lt;&gt; : Group rows and aggregate data.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;                           Example: groupby cat --agg count,avg:user.score&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;  product &lt;file&gt;         : Create a Cartesian product with another file.&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: product features.jsonl&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  union &lt;file&gt;           : Combine rows from another file (deduplicated).&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: union archived_users.jsonl&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  intersection &lt;file&gt;    : Keep only rows present in another file.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: intersection active_users.jsonl&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  difference &lt;file&gt;      : Remove rows present in another file.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;                           Example: difference temp_users.jsonl&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">--- Pipeline Control ---&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;  execute [--lines=N]    : Run the pipeline and see output (e.g., execute --lines=10).&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
        <span class="s2">&quot;  compile                : Show the bash script for the current pipeline.&quot;</span>
    <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  pipeline               : Show the steps in the current pipeline.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  reset                  : Clear the current pipeline.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  help                   : Show this help message.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  exit                   : Exit the REPL.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Tips:&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;- Use dot notation (e.g., `user.address.city`) for nested JSON fields.&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;- Wrap arguments with spaces in quotes (e.g., select &#39;name == &quot;John Doe&quot;&#39;).\n&quot;&quot;&quot;</span>
    <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_intersection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_intersection</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'intersection' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_intersection</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;intersection&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;intersection&#39; requires a file path.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;intersection&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_join" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'join' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_join</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;join&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">3</span> <span class="ow">or</span> <span class="n">args</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">!=</span> <span class="s2">&quot;--on&quot;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;join&#39; requires &lt;right_file&gt; --on &lt;key_map&gt;.&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Example: join orders.jsonl --on user.id=customer_id&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;join&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_pipeline_show" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_pipeline_show</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Display the steps in the current pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_pipeline_show</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Display the steps in the current pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipeline is empty.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Current pipeline:&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;  Input: </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  Input: stdin (assumed for the first command if &#39;from&#39; not used)&quot;</span>
            <span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">step</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span><span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;  </span><span class="si">{</span><span class="n">idx</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="si">}</span><span class="s2">. </span><span class="si">{</span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;repl_command&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">shlex</span><span class="o">.</span><span class="n">quote</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="w"> </span><span class="k">for</span><span class="w"> </span><span class="n">a</span><span class="w"> </span><span class="ow">in</span><span class="w"> </span><span class="n">step</span><span class="p">[</span><span class="s1">&#39;args&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_product" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_product</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'product' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_product</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;product&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;product&#39; requires a right file path.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;product&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_project" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_project</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'project' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_project</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;project&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;project&#39; requires column names.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;project&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_rename" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_rename</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'rename' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_rename</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;rename&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;rename&#39; requires a mapping (e.g., old_name=new_name).&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;rename&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_reset" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_reset</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Clear the current pipeline and reset the input source.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_reset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Clear the current pipeline and reset the input source.&quot;&quot;&quot;</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">pipeline</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">current_input_source</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Pipeline reset.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_select" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_select</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'select' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_select</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;select&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;select&#39; requires an expression.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;select&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_sort" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_sort</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'sort' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_sort</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;sort&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;sort&#39; requires column names.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;sort&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.handle_union" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_union</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Handle the 'union' command by adding it to the pipeline.</p>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_union</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle the &#39;union&#39; command by adding it to the pipeline.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">args</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Error: &#39;union&#39; requires a file path.&quot;</span><span class="p">)</span>
        <span class="k">return</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">add_to_pipeline</span><span class="p">(</span><span class="s2">&quot;union&quot;</span><span class="p">,</span> <span class="n">args</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.parse_command" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_command</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Parse a line of input into a command and its arguments.</p>
<p>Uses <code>shlex</code> to handle quoted arguments correctly.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>line</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The raw input line from the user.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A tuple of (command, args_list), or (None, None) if parsing fails.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_command</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a line of input into a command and its arguments.</span>

<span class="sd">    Uses `shlex` to handle quoted arguments correctly.</span>

<span class="sd">    Args:</span>
<span class="sd">        line (str): The raw input line from the user.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple of (command, args_list), or (None, None) if parsing fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error parsing command: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">. Check your quotes.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">parts</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
    <span class="n">command</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="n">args</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="k">return</span> <span class="n">command</span><span class="p">,</span> <span class="n">args</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.process" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">process</span><span class="p">(</span><span class="n">line</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Process a single line of input from the REPL.</p>
<p>This method parses the line, finds the appropriate handler for the
command, and invokes it.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>line</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The line of input to process.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">process</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">line</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Process a single line of input from the REPL.</span>

<span class="sd">    This method parses the line, finds the appropriate handler for the</span>
<span class="sd">    command, and invokes it.</span>

<span class="sd">    Args:</span>
<span class="sd">        line (str): The line of input to process.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">command</span><span class="p">,</span> <span class="n">cmd_args</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_command</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">command</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>  <span class="c1"># Parsing error</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">command</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">[</span><span class="n">command</span><span class="p">](</span><span class="n">cmd_args</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">command</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Unknown command: &#39;</span><span class="si">{</span><span class="n">command</span><span class="si">}</span><span class="s2">&#39;. Type &#39;help&#39; for available commands.&quot;</span>
            <span class="p">)</span>

    <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exiting...&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Interrupted. Use &#39;exit&#39; to quit.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">traceback</span>

        <span class="n">traceback</span><span class="o">.</span><span class="n">print_exc</span><span class="p">()</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.repl.ReplCompiler.run" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">run</span><span class="p">(</span><span class="n">initial_command_list</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Start the main REPL event loop.</p>
<p>This method prints a welcome message, registers all command handlers,
and enters an infinite loop to read and process user input.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>initial_command_list</code>
            </td>
            <td>
                  <code><span title="list">list</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of command-line arguments
                                   to process before starting the
                                   interactive loop.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">initial_command_list</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>  <span class="c1"># Renamed &#39;args&#39; for clarity</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Start the main REPL event loop.</span>

<span class="sd">    This method prints a welcome message, registers all command handlers,</span>
<span class="sd">    and enters an infinite loop to read and process user input.</span>

<span class="sd">    Args:</span>
<span class="sd">        initial_command_list (list, optional): A list of command-line arguments</span>
<span class="sd">                                               to process before starting the</span>
<span class="sd">                                               interactive loop.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Welcome to ja REPL. Type &#39;help&#39; for commands, &#39;exit&#39; to quit.&quot;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span> <span class="o">=</span> <span class="p">{</span>  <span class="c1"># Assign to self.handlers so self.process() can use it</span>
        <span class="s2">&quot;from&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_from</span><span class="p">,</span>
        <span class="s2">&quot;select&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_select</span><span class="p">,</span>
        <span class="s2">&quot;project&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_project</span><span class="p">,</span>
        <span class="s2">&quot;join&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_join</span><span class="p">,</span>
        <span class="s2">&quot;rename&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_rename</span><span class="p">,</span>
        <span class="s2">&quot;distinct&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_distinct</span><span class="p">,</span>
        <span class="s2">&quot;sort&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_sort</span><span class="p">,</span>
        <span class="s2">&quot;groupby&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_groupby</span><span class="p">,</span>
        <span class="s2">&quot;product&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_product</span><span class="p">,</span>
        <span class="s2">&quot;union&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_union</span><span class="p">,</span>
        <span class="s2">&quot;intersection&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_intersection</span><span class="p">,</span>
        <span class="s2">&quot;difference&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_difference</span><span class="p">,</span>
        <span class="s2">&quot;compile&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_compile</span><span class="p">,</span>
        <span class="s2">&quot;execute&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_execute</span><span class="p">,</span>
        <span class="s2">&quot;agg&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_agg</span><span class="p">,</span>
        <span class="s2">&quot;reset&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_reset</span><span class="p">,</span>
        <span class="s2">&quot;pipeline&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_pipeline_show</span><span class="p">,</span>
        <span class="s2">&quot;help&quot;</span><span class="p">:</span> <span class="bp">self</span><span class="o">.</span><span class="n">handle_help</span><span class="p">,</span>
        <span class="s2">&quot;exit&quot;</span><span class="p">:</span> <span class="k">lambda</span> <span class="n">_args</span><span class="p">:</span> <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span>
            <span class="mi">0</span>
        <span class="p">),</span>  <span class="c1"># Consistent signature with other handlers</span>
    <span class="p">}</span>

    <span class="k">if</span> <span class="n">initial_command_list</span> <span class="ow">and</span> <span class="nb">len</span><span class="p">(</span><span class="n">initial_command_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">processed_initial_parts</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">initial_command_list</span><span class="p">)</span>
        <span class="c1"># If the first token of initial_command_list is not a known REPL command,</span>
        <span class="c1"># assume &#39;from&#39; should be prepended.</span>
        <span class="c1"># This allows `ja repl myfile.jsonl` to be treated as `from myfile.jsonl`.</span>
        <span class="k">if</span> <span class="n">processed_initial_parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">handlers</span><span class="p">:</span>
            <span class="n">processed_initial_parts</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="s2">&quot;from&quot;</span><span class="p">)</span>

        <span class="n">initial_line</span> <span class="o">=</span> <span class="n">shlex</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
            <span class="n">processed_initial_parts</span>
        <span class="p">)</span>  <span class="c1"># Use shlex.join for safety</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">initial_line</span><span class="p">)</span>

    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">line</span> <span class="o">=</span> <span class="nb">input</span><span class="p">(</span><span class="s2">&quot;ja&gt; &quot;</span><span class="p">)</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">line</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="c1"># &#39;exit&#39; command will be handled by self.process -&gt; self.handlers[&#39;exit&#39;]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">process</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">EOFError</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Exiting...&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>  <span class="c1"># Ensure clean exit</span>
        <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Interrupted. Type &#39;exit&#39; or Ctrl-D to quit.&quot;</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>


<div class="doc doc-object doc-function">


<h3 id="ja.repl.repl" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">repl</span><span class="p">(</span><span class="n">parsed_cli_args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Entry point for the <code>ja repl</code> command.</p>
<p>Initializes and runs the ReplCompiler.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>parsed_cli_args</code>
            </td>
            <td>
                  <code><span title="argparse.Namespace">Namespace</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The parsed command-line arguments,
                                  which may include an initial file
                                  to load.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/repl.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">repl</span><span class="p">(</span><span class="n">parsed_cli_args</span><span class="p">):</span>  <span class="c1"># Receives the argparse.Namespace object</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Entry point for the `ja repl` command.</span>

<span class="sd">    Initializes and runs the ReplCompiler.</span>

<span class="sd">    Args:</span>
<span class="sd">        parsed_cli_args (argparse.Namespace): The parsed command-line arguments,</span>
<span class="sd">                                              which may include an initial file</span>
<span class="sd">                                              to load.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">compiler</span> <span class="o">=</span> <span class="n">ReplCompiler</span><span class="p">()</span>
    <span class="c1"># Get the list of initial arguments passed to `ja repl ...`</span>
    <span class="c1"># getattr default to empty list if &#39;initial_args&#39; is not present (it will be due to nargs=&quot;*&quot;)</span>
    <span class="n">initial_repl_args_list</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">parsed_cli_args</span><span class="p">,</span> <span class="s2">&quot;initial_args&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">compiler</span><span class="o">.</span><span class="n">run</span><span class="p">(</span><span class="n">initial_command_list</span><span class="o">=</span><span class="n">initial_repl_args_list</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.commands" class="doc doc-heading">
            <code>ja.commands</code>


</h2>

    <div class="doc doc-contents first">

        <p>Command handlers for the JSONL algebra CLI.</p>
<p>This module connects the command-line interface to the core data processing
functions. Each <code>handle_*</code> function is responsible for reading input data,
calling the appropriate core function, and writing the results to stdout.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.commands.get_input_stream" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_input_stream</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Yield a readable file-like object.</p>
<ul>
<li>If file_path is None or '-', yield sys.stdin.</li>
<li>Otherwise open the given path for reading.</li>
</ul>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="nd">@contextmanager</span>
<span class="k">def</span><span class="w"> </span><span class="nf">get_input_stream</span><span class="p">(</span><span class="n">file_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Yield a readable file-like object.</span>

<span class="sd">    - If file_path is None or &#39;-&#39;, yield sys.stdin.</span>
<span class="sd">    - Otherwise open the given path for reading.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">file_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">file_path</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">f</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">f</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="n">f</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">sys</span><span class="o">.</span><span class="n">stdin</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_agg" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_agg</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle agg command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_agg</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle agg command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">write_jsonl</span><span class="p">([])</span>
        <span class="k">return</span>

    <span class="c1"># Check if input has group metadata - use new format</span>
    <span class="k">if</span> <span class="s2">&quot;_groups&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
        <span class="c1"># Process grouped data</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">aggregate_grouped_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">agg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Process ungrouped data</span>
        <span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">aggregate_single_group</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">agg</span><span class="p">)]</span>

    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_collect" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_collect</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle collect command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_collect</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle collect command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">write_jsonl</span><span class="p">([])</span>
        <span class="k">return</span>

    <span class="c1"># Check for streaming flag</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;streaming&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">streaming</span><span class="p">:</span>
        <span class="n">json_error</span><span class="p">(</span>
            <span class="s2">&quot;StreamingError&quot;</span><span class="p">,</span>
            <span class="s2">&quot;Collect operation requires seeing all data and cannot be performed in streaming mode. &quot;</span>
            <span class="s2">&quot;Remove --streaming flag or use window-based processing with --window-size&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Handle window-based collection</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;window_size&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">window_size</span><span class="p">:</span>
        <span class="c1"># Process data in windows</span>
        <span class="n">window_size</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">window_size</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">),</span> <span class="n">window_size</span><span class="p">):</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="n">i</span> <span class="p">:</span> <span class="n">i</span> <span class="o">+</span> <span class="n">window_size</span><span class="p">]</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">window</span><span class="p">)</span>
            <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Collect all data at once</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">collect</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_difference" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_difference</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle difference command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_difference</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle difference command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">left</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">left_data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">right_data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">difference</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_distinct" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_distinct</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle distinct command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_distinct</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle distinct command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">distinct</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_explode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_explode</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle explode command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_explode</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle explode command.&quot;&quot;&quot;</span>
    <span class="n">input_filename_stem</span> <span class="o">=</span> <span class="s2">&quot;jsonl_output&quot;</span>  <span class="c1"># Default stem</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="o">!=</span> <span class="s2">&quot;-&quot;</span><span class="p">:</span>
        <span class="n">input_filename_stem</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">stem</span>

    <span class="n">output_directory</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">output_dir</span> <span class="k">else</span> <span class="n">input_filename_stem</span>

    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_stream</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">jsonl_to_dir</span><span class="p">(</span><span class="n">input_stream</span><span class="p">,</span> <span class="n">output_directory</span><span class="p">,</span> <span class="n">input_filename_stem</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error during explode operation: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_groupby" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_groupby</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle groupby command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_groupby</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle groupby command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;agg&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">agg</span><span class="p">:</span>
        <span class="c1"># Traditional groupby with aggregation</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">groupby_agg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">key</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">agg</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Check if input is already grouped - look for new format</span>
        <span class="k">if</span> <span class="n">data</span> <span class="ow">and</span> <span class="s2">&quot;_groups&quot;</span> <span class="ow">in</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="c1"># This is a chained groupby</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">groupby_chained</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># First groupby</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">groupby_with_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">key</span><span class="p">)</span>

    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_implode" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_implode</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle implode command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_implode</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle implode command.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">dir_to_jsonl_lines</span><span class="p">(</span>
            <span class="n">args</span><span class="o">.</span><span class="n">input_dir</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">add_filename_key</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">recursive</span>
        <span class="p">):</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during implode: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_import_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_import_csv</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle import-csv command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_import_csv</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle import-csv command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_stream</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">csv_to_jsonl_lines</span><span class="p">(</span>
                <span class="n">input_stream</span><span class="p">,</span> <span class="n">has_header</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">has_header</span><span class="p">,</span> <span class="n">infer_types</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">infer_types</span>
            <span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during CSV import: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_intersection" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_intersection</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle intersection command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_intersection</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle intersection command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">left</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">left_data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">right_data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">intersection</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_join" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_join</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle join command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_join</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle join command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">left</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">left</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">right</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">lcol_str</span><span class="p">,</span> <span class="n">rcol_str</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">on</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">lcol</span> <span class="o">=</span> <span class="n">lcol_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="n">rcol</span> <span class="o">=</span> <span class="n">rcol_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">join</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="p">[(</span><span class="n">lcol</span><span class="p">,</span> <span class="n">rcol</span><span class="p">)])</span>
    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_product" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_product</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle product command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_product</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle product command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">left</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">left_data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">right_data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">product</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_project" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_project</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle project command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_project</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle project command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">use_jmespath</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;jmespath&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">jmespath</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">project</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">use_jmespath</span><span class="o">=</span><span class="n">use_jmespath</span><span class="p">)</span>
        <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jmespath</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">json_error</span><span class="p">(</span>
            <span class="s2">&quot;JMESPathParseError&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid JMESPath expression: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;expression&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">expr</span><span class="p">},</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_rename" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_rename</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle rename command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_rename</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle rename command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">mapping_pairs</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">mapping</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">pair_str</span> <span class="ow">in</span> <span class="n">mapping_pairs</span><span class="p">:</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">pair_str</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">old_name</span><span class="p">,</span> <span class="n">new_name</span> <span class="o">=</span> <span class="n">parts</span>
            <span class="n">mapping</span><span class="p">[</span><span class="n">old_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span> <span class="o">=</span> <span class="n">new_name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Warning: Malformed rename pair &#39;</span><span class="si">{</span><span class="n">pair_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2">&#39; ignored.&quot;</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">rename</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>
    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_schema_infer" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_schema_infer</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle schema infer command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_schema_infer</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle schema infer command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">schema</span> <span class="o">=</span> <span class="n">infer_schema</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="n">write_json_object</span><span class="p">(</span><span class="n">schema</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_schema_validate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_schema_validate</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle schema validate command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_schema_validate</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle schema validate command.&quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">jsonschema</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;jsonschema is not installed. Please install it with: pip install jsonschema&quot;</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># Can&#39;t read both from stdin</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">schema</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Error: When reading schema from stdin, a file argument for the data to validate must be provided.&quot;</span><span class="p">,</span>
            <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">schema</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">schema</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Error reading or parsing schema file </span><span class="si">{</span><span class="n">args</span><span class="o">.</span><span class="n">schema</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
        <span class="p">)</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># If schema was from stdin, the file MUST be from a file, not stdin.</span>
    <span class="n">data_source</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">schema</span> <span class="o">==</span> <span class="s2">&quot;-&quot;</span> <span class="k">else</span> <span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">data_source</span><span class="p">)</span> <span class="k">as</span> <span class="n">lines</span><span class="p">:</span>
        <span class="n">validation_failed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">lines</span><span class="p">,</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">instance</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">jsonschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">instance</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">schema</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
            <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error decoding JSON on line </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">validation_failed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">except</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ValidationError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation error on line </span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="o">.</span><span class="n">message</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
                <span class="n">validation_failed</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">validation_failed</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_select" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_select</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle select command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_select</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle select command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">use_jmespath</span> <span class="o">=</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">args</span><span class="p">,</span> <span class="s2">&quot;jmespath&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">args</span><span class="o">.</span><span class="n">jmespath</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">select</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">expr</span><span class="p">,</span> <span class="n">use_jmespath</span><span class="o">=</span><span class="n">use_jmespath</span><span class="p">)</span>
        <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">jmespath</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">ParseError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">json_error</span><span class="p">(</span>
            <span class="s2">&quot;JMESPathParseError&quot;</span><span class="p">,</span>
            <span class="sa">f</span><span class="s2">&quot;Invalid JMESPath expression: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
            <span class="p">{</span><span class="s2">&quot;expression&quot;</span><span class="p">:</span> <span class="n">args</span><span class="o">.</span><span class="n">expr</span><span class="p">},</span>
        <span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_sort" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_sort</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle sort command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_sort</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle sort command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">sort_by</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">args</span><span class="o">.</span><span class="n">keys</span><span class="p">,</span> <span class="n">descending</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">desc</span><span class="p">)</span>
    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_to_array" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_to_array</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle to-array command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_to_array</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle to-array command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_stream</span><span class="p">:</span>
        <span class="n">array_string</span> <span class="o">=</span> <span class="n">jsonl_to_json_array_string</span><span class="p">(</span><span class="n">input_stream</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">array_string</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_to_csv" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_to_csv</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle to-csv command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_to_csv</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle to-csv command.&quot;&quot;&quot;</span>
    <span class="n">column_functions</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">apply</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">expr_str</span> <span class="ow">in</span> <span class="n">args</span><span class="o">.</span><span class="n">apply</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># WARNING: eval() is a security risk if the expression is not from a trusted source.</span>
                <span class="n">func</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">expr_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">callable</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Expression for column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; did not evaluate to a callable function.&quot;</span>
                    <span class="p">)</span>
                <span class="n">column_functions</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Error parsing --apply expression for column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_stream</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">jsonl_to_csv_stream</span><span class="p">(</span>
                <span class="n">input_stream</span><span class="p">,</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span>
                <span class="n">flatten</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">flatten</span><span class="p">,</span>
                <span class="n">flatten_sep</span><span class="o">=</span><span class="n">args</span><span class="o">.</span><span class="n">flatten_sep</span><span class="p">,</span>
                <span class="n">column_functions</span><span class="o">=</span><span class="n">column_functions</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;An unexpected error occurred during CSV export: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
            <span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_to_jsonl" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_to_jsonl</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle to-jsonl command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_to_jsonl</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle to-jsonl command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">input_stream</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">json_array_to_jsonl_lines</span><span class="p">(</span><span class="n">input_stream</span><span class="p">):</span>
                <span class="nb">print</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.handle_union" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">handle_union</span><span class="p">(</span><span class="n">args</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Handle union command.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">handle_union</span><span class="p">(</span><span class="n">args</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Handle union command.&quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">left</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">left_data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="k">with</span> <span class="n">get_input_stream</span><span class="p">(</span><span class="n">args</span><span class="o">.</span><span class="n">right</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">right_data</span> <span class="o">=</span> <span class="n">read_jsonl</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

    <span class="n">result</span> <span class="o">=</span> <span class="n">union</span><span class="p">(</span><span class="n">left_data</span><span class="p">,</span> <span class="n">right_data</span><span class="p">)</span>
    <span class="n">write_jsonl</span><span class="p">(</span><span class="n">result</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.json_error" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">json_error</span><span class="p">(</span><span class="n">error_type</span><span class="p">,</span> <span class="n">message</span><span class="p">,</span> <span class="n">details</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Print a JSON error message to stderr and exit.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">json_error</span><span class="p">(</span><span class="n">error_type</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">message</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Print a JSON error message to stderr and exit.&quot;&quot;&quot;</span>
    <span class="n">error_info</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;error&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">error_type</span><span class="p">,</span>
            <span class="s2">&quot;message&quot;</span><span class="p">:</span> <span class="n">message</span><span class="p">,</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">if</span> <span class="n">details</span><span class="p">:</span>
        <span class="n">error_info</span><span class="p">[</span><span class="s2">&quot;error&quot;</span><span class="p">][</span><span class="s2">&quot;details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">error_info</span><span class="p">),</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.read_jsonl" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">read_jsonl</span><span class="p">(</span><span class="n">input_stream</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Read JSONL data from a file-like object.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">read_jsonl</span><span class="p">(</span><span class="n">input_stream</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read JSONL data from a file-like object.&quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">input_stream</span><span class="p">]</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.write_json_object" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_json_object</span><span class="p">(</span><span class="n">obj</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Write a single object as pretty-printed JSON to stdout.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_json_object</span><span class="p">(</span><span class="n">obj</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a single object as pretty-printed JSON to stdout.&quot;&quot;&quot;</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.commands.write_jsonl" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">write_jsonl</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Write a collection of objects as JSONL to stdout.</p>


            <details class="quote">
              <summary>Source code in <code>ja/commands.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">write_jsonl</span><span class="p">(</span><span class="n">rows</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]])</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Write a collection of objects as JSONL to stdout.&quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.group" class="doc doc-heading">
            <code>ja.group</code>


</h2>

    <div class="doc doc-contents first">

        <p>Grouping operations for JSONL algebra.</p>
<p>This module provides grouping functionality that supports both immediate
aggregation and metadata-based chaining for multi-level grouping.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.group.groupby_agg" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">groupby_agg</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">group_key</span><span class="p">,</span> <span class="n">agg_spec</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Group and aggregate in one operation.</p>
<p>This function is kept for backward compatibility and for the --agg flag.
It's more efficient for simple cases but less flexible than chaining.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.group.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries to group and aggregate</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>group_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field to group by</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>agg_spec</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Aggregation specification</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.group.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of aggregated results, one per group</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/group.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">groupby_agg</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">group_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">agg_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Group and aggregate in one operation.</span>

<span class="sd">    This function is kept for backward compatibility and for the --agg flag.</span>
<span class="sd">    It&#39;s more efficient for simple cases but less flexible than chaining.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries to group and aggregate</span>
<span class="sd">        group_key: Field to group by</span>
<span class="sd">        agg_spec: Aggregation specification</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of aggregated results, one per group</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ExprEval</span><span class="p">()</span>

    <span class="c1"># Group data</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="n">key</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">group_key</span><span class="p">)</span>
        <span class="n">groups</span><span class="p">[</span><span class="n">key</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="c1"># Apply aggregations</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">agg_specs</span> <span class="o">=</span> <span class="n">parse_agg_specs</span><span class="p">(</span><span class="n">agg_spec</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">group_rows</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">row_result</span> <span class="o">=</span> <span class="p">{</span><span class="n">group_key</span><span class="p">:</span> <span class="n">key</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">agg_specs</span><span class="p">:</span>
            <span class="n">row_result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">apply_single_agg</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">group_rows</span><span class="p">))</span>
        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row_result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.group.groupby_chained" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">groupby_chained</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">,</span> <span class="n">new_group_key</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply groupby to already-grouped data.</p>
<p>This function handles multi-level grouping by building on existing
group metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>grouped_data</code>
            </td>
            <td>
                  <code><span title="ja.group.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data with existing group metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>new_group_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field to group by</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.group.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List with nested group metadata</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/group.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">groupby_chained</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">new_group_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply groupby to already-grouped data.</span>

<span class="sd">    This function handles multi-level grouping by building on existing</span>
<span class="sd">    group metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        grouped_data: Data with existing group metadata</span>
<span class="sd">        new_group_key: Field to group by</span>

<span class="sd">    Returns:</span>
<span class="sd">        List with nested group metadata</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ExprEval</span><span class="p">()</span>

    <span class="c1"># Group within existing groups</span>
    <span class="n">nested_groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="p">:</span>
        <span class="c1"># Get existing groups</span>
        <span class="n">existing_groups</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_groups&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(row, file=sys.stderr)</span>
            <span class="n">key_value</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">new_group_key</span><span class="p">)</span>
            <span class="n">nested_groups</span><span class="p">[</span><span class="n">key_value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">key_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">nested_groups</span><span class="p">[</span><span class="n">key_value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

        <span class="n">new_key_value</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">new_group_key</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing row:&quot;</span><span class="p">,</span> <span class="n">row</span><span class="p">,</span> <span class="s2">&quot;New group key:&quot;</span><span class="p">,</span> <span class="n">new_group_key</span><span class="p">,</span> <span class="s2">&quot;Value:&quot;</span><span class="p">,</span> <span class="n">new_key_value</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

        <span class="c1"># Create a tuple key for grouping (for internal use only)</span>

        <span class="n">group_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">existing_groups</span><span class="p">)</span>
        <span class="n">group_tuple</span> <span class="o">+=</span> <span class="p">((</span><span class="n">new_group_key</span><span class="p">,</span> <span class="n">new_key_value</span><span class="p">),)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Hmm...&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>

            <span class="n">nested_groups</span><span class="p">[</span><span class="n">group_tuple</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="c1"># make group_tuple hashable</span>
            <span class="c1"># here is how to do it: </span>
            <span class="n">group_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">str</span><span class="p">,</span> <span class="n">group_tuple</span><span class="p">))</span>
            <span class="n">nested_groups</span><span class="p">[</span><span class="n">group_tuple</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="c1"># Add new metadata</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">group_tuple</span><span class="p">,</span> <span class="n">group_rows</span> <span class="ow">in</span> <span class="n">nested_groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">group_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_rows</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_rows</span><span class="p">):</span>
            <span class="n">new_row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="n">value</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">new_group_key</span><span class="p">)</span>

            <span class="c1"># Extend the groups list</span>
            <span class="n">new_row</span><span class="p">[</span><span class="s2">&quot;_groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_groups&quot;</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">new_row</span><span class="p">[</span><span class="s2">&quot;_groups&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">({</span>
                <span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">new_group_key</span><span class="p">,</span>
                <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">value</span>
            <span class="p">})</span>

            <span class="n">new_row</span><span class="p">[</span><span class="s2">&quot;_group_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_size</span>
            <span class="n">new_row</span><span class="p">[</span><span class="s2">&quot;_group_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.group.groupby_with_metadata" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">groupby_with_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">group_key</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Group data and add metadata fields.</p>
<p>This function enables chained groupby operations by adding special
metadata fields to each row:
- _groups: List of {field, value} objects representing the grouping hierarchy
- _group_size: Total number of rows in this group
- _group_index: This row's index within its group</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.group.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries to group</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>group_key</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Field to group by (supports dot notation)</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.group.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List with group metadata added to each row</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/group.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">groupby_with_metadata</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">group_key</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Group data and add metadata fields.</span>

<span class="sd">    This function enables chained groupby operations by adding special</span>
<span class="sd">    metadata fields to each row:</span>
<span class="sd">    - _groups: List of {field, value} objects representing the grouping hierarchy</span>
<span class="sd">    - _group_size: Total number of rows in this group</span>
<span class="sd">    - _group_index: This row&#39;s index within its group</span>

<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries to group</span>
<span class="sd">        group_key: Field to group by (supports dot notation)</span>

<span class="sd">    Returns:</span>
<span class="sd">        List with group metadata added to each row</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ExprEval</span><span class="p">()</span>

    <span class="c1"># First pass: collect groups</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># print(row, file=sys.stderr)</span>
            <span class="n">key_value</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">group_key</span><span class="p">)</span>
            <span class="n">groups</span><span class="p">[</span><span class="n">key_value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">key_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">key_value</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sort_keys</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">groups</span><span class="p">[</span><span class="n">key_value</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">)</span>

    <span class="kn">import</span><span class="w"> </span><span class="nn">sys</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;hi&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="c1"># print(&quot;Huh?&quot;)</span>
    <span class="c1"># Second pass: add metadata and flatten</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_index</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">groups</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">group_value</span><span class="p">,</span> <span class="n">group_rows</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing group:&quot;</span><span class="p">,</span> <span class="n">group_value</span><span class="p">,</span> <span class="s2">&quot;Size:&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_rows</span><span class="p">),</span> <span class="s2">&quot;Index:&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span>   <span class="s2">&quot;Last Index:&quot;</span><span class="p">,</span> <span class="n">last_index</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="n">group_size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">group_rows</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">index</span><span class="p">,</span> <span class="n">row</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">group_rows</span><span class="p">):</span>
            <span class="c1"># Create new row with metadata</span>
            <span class="n">new_row</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="c1"># check if group_value is a serialized json value</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">group_value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">group_value</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">group_value</span><span class="p">)</span>
                    <span class="c1"># print(group_value)</span>
                    <span class="c1"># print(&quot;Deserialized group value:&quot;, group_value)</span>
                <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">:</span>
                    <span class="k">pass</span>
                    <span class="c1"># print({&quot;Huh?&quot;})</span>
            <span class="c1"># print(&quot;Processing group:&quot;, group_value, &quot;Size:&quot;, group_size)</span>
            <span class="n">new_row</span><span class="p">[</span><span class="s2">&quot;_groups&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[{</span><span class="s2">&quot;field&quot;</span><span class="p">:</span> <span class="n">group_key</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">group_value</span><span class="p">}]</span>
            <span class="n">new_row</span><span class="p">[</span><span class="s2">&quot;_group_size&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">group_size</span>
            <span class="n">new_row</span><span class="p">[</span><span class="s2">&quot;_group_index&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">new_row</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Done processing groups&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.agg" class="doc doc-heading">
            <code>ja.agg</code>


</h2>

    <div class="doc doc-contents first">

        <p>Aggregation engine for JSONL algebra operations.</p>
<p>This module provides all aggregation functionality including parsing aggregation
specifications, applying aggregations to data, and all built-in aggregation
functions (sum, avg, min, max, etc.).</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.agg.aggregate_grouped_data" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_grouped_data</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">,</span> <span class="n">agg_spec</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Aggregate data that has group metadata.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>grouped_data</code>
            </td>
            <td>
                  <code><span title="ja.agg.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Data with group metadata</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>agg_spec</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Aggregation specification</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ja.agg.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of aggregated results</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/agg.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_grouped_data</span><span class="p">(</span><span class="n">grouped_data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">agg_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Relation</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate data that has group metadata.</span>

<span class="sd">    Args:</span>
<span class="sd">        grouped_data: Data with group metadata</span>
<span class="sd">        agg_spec: Aggregation specification</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of aggregated results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span><span class="w"> </span><span class="nn">collections</span><span class="w"> </span><span class="kn">import</span> <span class="n">defaultdict</span>

    <span class="c1"># Group by the combination of all grouping fields</span>
    <span class="n">groups</span> <span class="o">=</span> <span class="n">defaultdict</span><span class="p">(</span><span class="nb">list</span><span class="p">)</span>
    <span class="n">group_keys</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">grouped_data</span><span class="p">:</span>
        <span class="c1"># Use the _groups list to create a grouping key</span>
        <span class="n">groups_list</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;_groups&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Create a tuple key for internal grouping</span>
        <span class="n">group_tuple</span> <span class="o">=</span> <span class="nb">tuple</span><span class="p">((</span><span class="n">g</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">],</span> <span class="n">g</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">g</span> <span class="ow">in</span> <span class="n">groups_list</span><span class="p">)</span>

        <span class="c1"># Store the groups for this tuple</span>
        <span class="k">if</span> <span class="n">group_tuple</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">group_keys</span><span class="p">:</span>
            <span class="n">group_keys</span><span class="p">[</span><span class="n">group_tuple</span><span class="p">]</span> <span class="o">=</span> <span class="n">groups_list</span>

        <span class="c1"># Remove metadata for aggregation</span>
        <span class="n">clean_row</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;_group&quot;</span><span class="p">)}</span>
        <span class="n">groups</span><span class="p">[</span><span class="n">group_tuple</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">clean_row</span><span class="p">)</span>

    <span class="c1"># Apply aggregations</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">for</span> <span class="n">group_tuple</span><span class="p">,</span> <span class="n">group_rows</span> <span class="ow">in</span> <span class="n">groups</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># Start with all grouping fields</span>
        <span class="n">agg_result</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="c1"># Add all grouping fields from the metadata</span>
        <span class="k">for</span> <span class="n">group_info</span> <span class="ow">in</span> <span class="n">group_keys</span><span class="p">[</span><span class="n">group_tuple</span><span class="p">]:</span>
            <span class="n">agg_result</span><span class="p">[</span><span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;field&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">group_info</span><span class="p">[</span><span class="s2">&quot;value&quot;</span><span class="p">]</span>

        <span class="c1"># Parse and apply aggregations</span>
        <span class="n">agg_specs</span> <span class="o">=</span> <span class="n">parse_agg_specs</span><span class="p">(</span><span class="n">agg_spec</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">agg_specs</span><span class="p">:</span>
            <span class="n">agg_result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">apply_single_agg</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">group_rows</span><span class="p">))</span>

        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">agg_result</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.agg.aggregate_single_group" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">aggregate_single_group</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">agg_spec</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Aggregate ungrouped data as a single group.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.agg.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>agg_spec</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Aggregation specification</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with aggregation results</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/agg.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">aggregate_single_group</span><span class="p">(</span><span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">,</span> <span class="n">agg_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Aggregate ungrouped data as a single group.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: List of dictionaries</span>
<span class="sd">        agg_spec: Aggregation specification</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with aggregation results</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">agg_specs</span> <span class="o">=</span> <span class="n">parse_agg_specs</span><span class="p">(</span><span class="n">agg_spec</span><span class="p">)</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">for</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">agg_specs</span><span class="p">:</span>
        <span class="n">result</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">apply_single_agg</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">data</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">result</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.agg.apply_single_agg" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">apply_single_agg</span><span class="p">(</span><span class="n">spec</span><span class="p">,</span> <span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Apply a single aggregation to data.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>spec</code>
            </td>
            <td>
                  <code><span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, <span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(name, expression) tuple</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
                  <code><span title="ja.agg.Relation">Relation</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of dictionaries</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Dictionary with aggregation result</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/agg.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">apply_single_agg</span><span class="p">(</span><span class="n">spec</span><span class="p">:</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">],</span> <span class="n">data</span><span class="p">:</span> <span class="n">Relation</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Apply a single aggregation to data.</span>

<span class="sd">    Args:</span>
<span class="sd">        spec: (name, expression) tuple</span>
<span class="sd">        data: List of dictionaries</span>

<span class="sd">    Returns:</span>
<span class="sd">        Dictionary with aggregation result</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">spec</span>
    <span class="n">parser</span> <span class="o">=</span> <span class="n">ExprEval</span><span class="p">()</span>

    <span class="c1"># Parse the aggregation expression</span>
    <span class="k">if</span> <span class="s2">&quot;(&quot;</span> <span class="ow">in</span> <span class="n">expr</span> <span class="ow">and</span> <span class="n">expr</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;)&quot;</span><span class="p">):</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[:</span><span class="n">expr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)]</span>
        <span class="n">field_expr</span> <span class="o">=</span> <span class="n">expr</span><span class="p">[</span><span class="n">expr</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;(&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">func_name</span> <span class="o">=</span> <span class="n">expr</span>
        <span class="n">field_expr</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Handle conditional aggregations</span>
    <span class="k">if</span> <span class="s2">&quot;_if&quot;</span> <span class="ow">in</span> <span class="n">func_name</span><span class="p">:</span>
        <span class="c1"># e.g., count_if(status == active) or sum_if(amount, status == paid)</span>
        <span class="n">base_func</span> <span class="o">=</span> <span class="n">func_name</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_if&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;,&quot;</span> <span class="ow">in</span> <span class="n">field_expr</span><span class="p">:</span>
            <span class="c1"># sum_if(amount, status == paid)</span>
            <span class="n">field</span><span class="p">,</span> <span class="n">condition</span> <span class="o">=</span> <span class="n">field_expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">field</span> <span class="o">=</span> <span class="n">field</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">condition</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

            <span class="c1"># Filter data based on condition</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">parser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">condition</span><span class="p">,</span> <span class="n">row</span><span class="p">)]</span>

            <span class="c1"># Apply base aggregation to filtered data</span>
            <span class="k">if</span> <span class="n">base_func</span> <span class="o">==</span> <span class="s2">&quot;sum&quot;</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_data</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)}</span>
            <span class="k">elif</span> <span class="n">base_func</span> <span class="o">==</span> <span class="s2">&quot;avg&quot;</span><span class="p">:</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">field</span><span class="p">)</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">filtered_data</span><span class="p">]</span>
                <span class="n">values</span> <span class="o">=</span> <span class="p">[</span><span class="n">v</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span> <span class="k">if</span> <span class="n">v</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">]</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">sum</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">values</span><span class="p">)</span> <span class="k">if</span> <span class="n">values</span> <span class="k">else</span> <span class="mi">0</span><span class="p">}</span>
            <span class="k">elif</span> <span class="n">base_func</span> <span class="o">==</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">)}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># count_if(status == active)</span>
            <span class="n">filtered_data</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span> <span class="k">if</span> <span class="n">parser</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="n">field_expr</span><span class="p">,</span> <span class="n">row</span><span class="p">)]</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">filtered_data</span><span class="p">)}</span>

    <span class="c1"># Regular aggregations</span>
    <span class="k">if</span> <span class="n">func_name</span> <span class="o">==</span> <span class="s2">&quot;count&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">data</span><span class="p">)}</span>

    <span class="k">elif</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="n">AGGREGATION_FUNCTIONS</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">func_name</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;first&quot;</span><span class="p">,</span> <span class="s2">&quot;last&quot;</span><span class="p">]:</span>
            <span class="c1"># Special handling for first/last</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">if</span> <span class="n">func_name</span> <span class="o">==</span> <span class="s2">&quot;first&quot;</span> <span class="k">else</span> <span class="n">data</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">field_expr</span><span class="p">)</span> <span class="k">if</span> <span class="n">field_expr</span> <span class="k">else</span> <span class="n">row</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">value</span><span class="p">}</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Collect values for aggregation</span>
            <span class="n">values</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">field_expr</span><span class="p">:</span>
                    <span class="c1"># Try arithmetic evaluation first</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">evaluate_arithmetic</span><span class="p">(</span><span class="n">field_expr</span><span class="p">,</span> <span class="n">row</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">val</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">field_expr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">val</span> <span class="o">=</span> <span class="n">row</span>
                <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">values</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>

            <span class="c1"># Apply aggregation functionsum(_agg_numeric_values(values))</span>
            <span class="n">result</span> <span class="o">=</span> <span class="n">AGGREGATION_FUNCTIONS</span><span class="p">[</span><span class="n">func_name</span><span class="p">](</span><span class="n">values</span><span class="p">)</span>
            <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">result</span><span class="p">}</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.agg.parse_agg_specs" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_agg_specs</span><span class="p">(</span><span class="n">agg_spec</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Parse aggregation specification string.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>agg_spec</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Aggregation specification (e.g., "count, avg_age=avg(age)")</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.List">List</span>[<span title="typing.Tuple">Tuple</span>[<span title="str">str</span>, <span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>List of (name, expression) tuples</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/agg.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_agg_specs</span><span class="p">(</span><span class="n">agg_spec</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse aggregation specification string.</span>

<span class="sd">    Args:</span>
<span class="sd">        agg_spec: Aggregation specification (e.g., &quot;count, avg_age=avg(age)&quot;)</span>

<span class="sd">    Returns:</span>
<span class="sd">        List of (name, expression) tuples</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">specs</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">agg_spec</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">):</span>
        <span class="n">part</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
        <span class="k">if</span> <span class="s2">&quot;=&quot;</span> <span class="ow">in</span> <span class="n">part</span><span class="p">:</span>
            <span class="c1"># Named aggregation: avg_age=avg(age)</span>
            <span class="n">name</span><span class="p">,</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">part</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">(),</span> <span class="n">expr</span><span class="o">.</span><span class="n">strip</span><span class="p">()))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Simple aggregation: count</span>
            <span class="n">specs</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">part</span><span class="p">,</span> <span class="n">part</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">specs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.export" class="doc doc-heading">
            <code>ja.export</code>


</h2>

    <div class="doc doc-contents first">

        <p>Utilities for exporting JSONL data to other formats.</p>
<p>This module provides a collection of functions for converting JSONL data into
various other formats. It powers the <code>ja export</code> command group, enabling
transformations like converting JSONL to a standard JSON array or "exploding"
a JSONL file into a directory of individual JSON files.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.export.dir_to_jsonl" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dir_to_jsonl</span><span class="p">(</span><span class="n">input_dir_path_str</span><span class="p">,</span> <span class="n">add_filename_key</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Converts JSON files in a directory to JSONL lines.
Files are sorted by 'item-<index>.json' pattern if applicable, otherwise lexicographically.
Optionally adds filename as a key to each JSON object.</p>


            <details class="quote">
              <summary>Source code in <code>ja/export.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dir_to_jsonl</span><span class="p">(</span>
    <span class="n">input_dir_path_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">add_filename_key</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="n">recursive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Converts JSON files in a directory to JSONL lines.</span>
<span class="sd">    Files are sorted by &#39;item-&lt;index&gt;.json&#39; pattern if applicable, otherwise lexicographically.</span>
<span class="sd">    Optionally adds filename as a key to each JSON object.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">input_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">input_dir_path_str</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Input path is not a directory: </span><span class="si">{</span><span class="n">input_dir_path_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">json_files_paths</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">if</span> <span class="n">recursive</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">input_dir</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
                    <span class="n">json_files_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">root</span><span class="p">)</span> <span class="o">/</span> <span class="n">file</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">input_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">item</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">item</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
                <span class="n">json_files_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>

    <span class="n">sorted_file_paths</span> <span class="o">=</span> <span class="n">_sort_files_for_implode</span><span class="p">(</span><span class="n">json_files_paths</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">file_path</span> <span class="ow">in</span> <span class="n">sorted_file_paths</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">add_filename_key</span><span class="p">:</span>
                <span class="c1"># Use relative path from the input_dir to keep it cleaner</span>
                <span class="n">relative_filename</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">file_path</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">input_dir</span><span class="p">))</span>
                <span class="n">actual_key</span> <span class="o">=</span> <span class="n">_ensure_unique_key</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">add_filename_key</span><span class="p">)</span>
                <span class="n">data</span><span class="p">[</span><span class="n">actual_key</span><span class="p">]</span> <span class="o">=</span> <span class="n">relative_filename</span>

            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping invalid JSON file: </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2"> - Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span>
            <span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing file </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
            <span class="k">continue</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.export.json_array_to_jsonl_lines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">json_array_to_jsonl_lines</span><span class="p">(</span><span class="n">json_array_input_stream</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Read a JSON array from a stream and yield each element as a JSONL line.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>json_array_input_stream</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input stream containing a JSON array.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>JSON strings representing each array element.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the input is not a valid JSON array.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/export.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">json_array_to_jsonl_lines</span><span class="p">(</span><span class="n">json_array_input_stream</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read a JSON array from a stream and yield each element as a JSONL line.</span>

<span class="sd">    Args:</span>
<span class="sd">        json_array_input_stream: Input stream containing a JSON array.</span>

<span class="sd">    Yields:</span>
<span class="sd">        JSON strings representing each array element.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ValueError: If the input is not a valid JSON array.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">json_string</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">json_array_input_stream</span><span class="p">)</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">json_string</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Input is not a JSON array.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">record</span> <span class="ow">in</span> <span class="n">data</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">record</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Invalid JSON array input: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.export.jsonl_to_dir" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">jsonl_to_dir</span><span class="p">(</span><span class="n">jsonl_input_stream</span><span class="p">,</span> <span class="n">output_dir_path_str</span><span class="p">,</span> <span class="n">input_filename_stem</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Exports JSONL lines to individual JSON files in a directory.
The output directory is named after input_filename_stem if output_dir_path_str is not specific.
Files are named item-<index>.json.</p>


            <details class="quote">
              <summary>Source code in <code>ja/export.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">jsonl_to_dir</span><span class="p">(</span>
    <span class="n">jsonl_input_stream</span><span class="p">,</span> <span class="n">output_dir_path_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">input_filename_stem</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;data&quot;</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Exports JSONL lines to individual JSON files in a directory.</span>
<span class="sd">    The output directory is named after input_filename_stem if output_dir_path_str is not specific.</span>
<span class="sd">    Files are named item-&lt;index&gt;.json.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">pathlib</span><span class="o">.</span><span class="n">Path</span><span class="p">(</span><span class="n">output_dir_path_str</span><span class="p">)</span>

    <span class="c1"># If output_dir_path_str was just a name (not a path), it might be used as the stem.</span>
    <span class="c1"># If it&#39;s a directory, we use the provided input_filename_stem for the sub-directory.</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">output_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">()</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span>
    <span class="p">):</span>  <span class="c1"># A path like &quot;output/my_data&quot; where &quot;output&quot; exists</span>
        <span class="c1"># This case is tricky. Let&#39;s assume output_dir_path_str is the target directory.</span>
        <span class="k">pass</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">endswith</span><span class="p">((</span><span class="s2">&quot;.jsonl&quot;</span><span class="p">,</span> <span class="s2">&quot;.json&quot;</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">output_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="c1"># Treat as a new directory to be created directly</span>
        <span class="k">pass</span>
    <span class="k">else</span><span class="p">:</span>  <span class="c1"># Default behavior: create a subdirectory based on the input stem</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">input_filename_stem</span>

    <span class="n">output_dir</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">line</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">jsonl_input_stream</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">record</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
            <span class="n">file_path</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;item-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">.json&quot;</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                <span class="n">json</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">record</span><span class="p">,</span> <span class="n">f</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping invalid JSON line during export: </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> - Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">continue</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Exported </span><span class="si">{</span><span class="n">count</span><span class="si">}</span><span class="s2"> items to </span><span class="si">{</span><span class="n">output_dir</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.export.jsonl_to_json_array_string" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">jsonl_to_json_array_string</span><span class="p">(</span><span class="n">jsonl_input_stream</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Read JSONL from a stream and return a JSON array string.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>jsonl_input_stream</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Input stream containing JSONL data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A JSON array string containing all records.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/export.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">jsonl_to_json_array_string</span><span class="p">(</span><span class="n">jsonl_input_stream</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Read JSONL from a stream and return a JSON array string.</span>

<span class="sd">    Args:</span>
<span class="sd">        jsonl_input_stream: Input stream containing JSONL data.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A JSON array string containing all records.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">jsonl_input_stream</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">))</span>
        <span class="k">except</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Skipping invalid JSON line: </span><span class="si">{</span><span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="si">}</span><span class="s2"> - Error: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">continue</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">records</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.exporter" class="doc doc-heading">
            <code>ja.exporter</code>


</h2>

    <div class="doc doc-contents first">

        <p>Export your JSONL data to other popular formats like CSV.</p>
<p>This module is your gateway to the wider data ecosystem. It provides powerful
and flexible tools to convert your JSONL data into formats that are easy to
use with spreadsheets, traditional databases, or other data analysis tools.</p>
<p>The key feature is its intelligent handling of nested JSON, which can be
"flattened" into separate columns, making complex data accessible in a simple
CSV format.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.exporter.jsonl_to_csv_stream" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">jsonl_to_csv_stream</span><span class="p">(</span><span class="n">jsonl_stream</span><span class="p">,</span> <span class="n">output_stream</span><span class="p">,</span> <span class="n">flatten</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">flatten_sep</span><span class="o">=</span><span class="s1">&#39;.&#39;</span><span class="p">,</span> <span class="n">column_functions</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert a stream of JSONL data into a CSV stream.</p>
<p>This is a highly flexible function for exporting your data. It reads JSONL
records, intelligently discovers all possible headers (even if they vary
between lines), and writes to a CSV format.</p>
<p>It shines when dealing with nested data. By default, it will flatten
structures like <code>{"user": {"name": "X"}}</code> into a <code>user.name</code> column.
You can also provide custom functions to transform data on the fly.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>jsonl_stream</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An input stream (like a file handle) yielding JSONL strings.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_stream</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An output stream (like <code>sys.stdout</code> or a file handle)
           where the CSV data will be written.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>flatten</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>True</code>, nested dictionaries are flattened into columns
            with dot-separated keys. Defaults to <code>True</code>.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>flatten_sep</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The separator to use when flattening keys.
               Defaults to ".".</p>
              </div>
            </td>
            <td>
                  <code>&#39;.&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>column_functions</code>
            </td>
            <td>
                  <code><span title="dict">dict</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dictionary mapping column names to functions
                     that will be applied to that column's data
                     before writing to CSV. For example,
                     <code>{"price": float}</code>.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/exporter.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">jsonl_to_csv_stream</span><span class="p">(</span>
    <span class="n">jsonl_stream</span><span class="p">,</span>
    <span class="n">output_stream</span><span class="p">,</span>
    <span class="n">flatten</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">flatten_sep</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">column_functions</span><span class="p">:</span> <span class="nb">dict</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a stream of JSONL data into a CSV stream.</span>

<span class="sd">    This is a highly flexible function for exporting your data. It reads JSONL</span>
<span class="sd">    records, intelligently discovers all possible headers (even if they vary</span>
<span class="sd">    between lines), and writes to a CSV format.</span>

<span class="sd">    It shines when dealing with nested data. By default, it will flatten</span>
<span class="sd">    structures like `{&quot;user&quot;: {&quot;name&quot;: &quot;X&quot;}}` into a `user.name` column.</span>
<span class="sd">    You can also provide custom functions to transform data on the fly.</span>

<span class="sd">    Args:</span>
<span class="sd">        jsonl_stream: An input stream (like a file handle) yielding JSONL strings.</span>
<span class="sd">        output_stream: An output stream (like `sys.stdout` or a file handle)</span>
<span class="sd">                       where the CSV data will be written.</span>
<span class="sd">        flatten (bool): If `True`, nested dictionaries are flattened into columns</span>
<span class="sd">                        with dot-separated keys. Defaults to `True`.</span>
<span class="sd">        flatten_sep (str): The separator to use when flattening keys.</span>
<span class="sd">                           Defaults to &quot;.&quot;.</span>
<span class="sd">        column_functions (dict): A dictionary mapping column names to functions</span>
<span class="sd">                                 that will be applied to that column&#39;s data</span>
<span class="sd">                                 before writing to CSV. For example,</span>
<span class="sd">                                 `{&quot;price&quot;: float}`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">column_functions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">column_functions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># First pass: Discover all possible headers from the entire stream</span>
    <span class="n">records</span> <span class="o">=</span> <span class="p">[</span><span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">line</span><span class="p">)</span> <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">jsonl_stream</span> <span class="k">if</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="c1"># Apply column functions before flattening</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">col</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="n">column_functions</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">rec</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">rec</span><span class="p">[</span><span class="n">col</span><span class="p">]</span> <span class="o">=</span> <span class="n">func</span><span class="p">(</span><span class="n">rec</span><span class="p">[</span><span class="n">col</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># Optionally, log this error or handle it as needed</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Error applying function to column &#39;</span><span class="si">{</span><span class="n">col</span><span class="si">}</span><span class="s2">&#39; for a record: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                        <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">,</span>
                    <span class="p">)</span>

    <span class="k">if</span> <span class="n">flatten</span><span class="p">:</span>
        <span class="n">processed_records</span> <span class="o">=</span> <span class="p">[(</span><span class="n">_flatten_dict</span><span class="p">(</span><span class="n">rec</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="n">flatten_sep</span><span class="p">))</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">processed_records</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">:</span>
            <span class="n">processed_rec</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">dict</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                    <span class="n">processed_rec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">v</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">processed_rec</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">processed_records</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">processed_rec</span><span class="p">)</span>

    <span class="c1"># Discover all unique keys to form the CSV header</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">header_set</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">processed_records</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">rec</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">header_set</span><span class="p">:</span>
                <span class="n">header_set</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
                <span class="n">headers</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>

    <span class="c1"># Second pass: Write to the output stream</span>
    <span class="n">writer</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictWriter</span><span class="p">(</span><span class="n">output_stream</span><span class="p">,</span> <span class="n">fieldnames</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">lineterminator</span><span class="o">=</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writeheader</span><span class="p">()</span>
    <span class="n">writer</span><span class="o">.</span><span class="n">writerows</span><span class="p">(</span><span class="n">processed_records</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.importer" class="doc doc-heading">
            <code>ja.importer</code>


</h2>

    <div class="doc doc-contents first">

        <p>Import data from other formats like CSV into the world of JSONL.</p>
<p>This module is the bridge that brings your existing data into the JSONL Algebra
ecosystem. It provides a collection of powerful functions for converting various
data formats—such as CSV or directories of individual JSON files—into the clean,
line-oriented JSONL format that <code>ja</code> is built to handle.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.importer.csv_to_jsonl_lines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">csv_to_jsonl_lines</span><span class="p">(</span><span class="n">csv_input_stream</span><span class="p">,</span> <span class="n">has_header</span><span class="p">,</span> <span class="n">infer_types</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Convert a stream of CSV data into a stream of JSONL lines.</p>
<p>This function reads CSV data and transforms each row into a JSON object.
It can automatically handle headers to use as keys and can even infer the
data types of your values, converting them from strings to numbers or
booleans where appropriate.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>csv_input_stream</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An input stream (like a file handle) containing CSV data.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>has_header</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Set to <code>True</code> if the first row of the CSV is a header
               that should be used for JSON keys.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>infer_types</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If <code>True</code>, automatically convert values to <code>int</code>,
                <code>float</code>, <code>bool</code>, or <code>None</code>. Defaults to <code>False</code>.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A JSON-formatted string for each row in the CSV data.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/importer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">csv_to_jsonl_lines</span><span class="p">(</span><span class="n">csv_input_stream</span><span class="p">,</span> <span class="n">has_header</span><span class="p">:</span> <span class="nb">bool</span><span class="p">,</span> <span class="n">infer_types</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Convert a stream of CSV data into a stream of JSONL lines.</span>

<span class="sd">    This function reads CSV data and transforms each row into a JSON object.</span>
<span class="sd">    It can automatically handle headers to use as keys and can even infer the</span>
<span class="sd">    data types of your values, converting them from strings to numbers or</span>
<span class="sd">    booleans where appropriate.</span>

<span class="sd">    Args:</span>
<span class="sd">        csv_input_stream: An input stream (like a file handle) containing CSV data.</span>
<span class="sd">        has_header (bool): Set to `True` if the first row of the CSV is a header</span>
<span class="sd">                           that should be used for JSON keys.</span>
<span class="sd">        infer_types (bool): If `True`, automatically convert values to `int`,</span>
<span class="sd">                            `float`, `bool`, or `None`. Defaults to `False`.</span>

<span class="sd">    Yields:</span>
<span class="sd">        A JSON-formatted string for each row in the CSV data.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">infer_types</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">row</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">_infer_value</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">row</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>

    <span class="k">if</span> <span class="n">has_header</span><span class="p">:</span>
        <span class="c1"># Use DictReader which handles headers automatically</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">DictReader</span><span class="p">(</span><span class="n">csv_input_stream</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">process_row</span><span class="p">(</span><span class="n">row</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Use the standard reader and manually create dictionaries</span>
        <span class="n">reader</span> <span class="o">=</span> <span class="n">csv</span><span class="o">.</span><span class="n">reader</span><span class="p">(</span><span class="n">csv_input_stream</span><span class="p">)</span>
        <span class="n">headers</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">first_row</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">reader</span><span class="p">)</span>
            <span class="c1"># Generate headers based on the number of columns in the first row</span>
            <span class="n">headers</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;col_</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">first_row</span><span class="p">))]</span>
            <span class="c1"># Yield the first row which we&#39;ve already consumed</span>
            <span class="n">row_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">first_row</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">process_row</span><span class="p">(</span><span class="n">row_dict</span><span class="p">))</span>
        <span class="k">except</span> <span class="ne">StopIteration</span><span class="p">:</span>
            <span class="k">return</span>  <span class="c1"># Handle empty file</span>

        <span class="c1"># Yield the rest of the rows</span>
        <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">reader</span><span class="p">:</span>
            <span class="n">row_dict</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">headers</span><span class="p">,</span> <span class="n">row</span><span class="p">))</span>
            <span class="k">yield</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">process_row</span><span class="p">(</span><span class="n">row_dict</span><span class="p">))</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.importer.dir_to_jsonl_lines" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">dir_to_jsonl_lines</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Stream a directory of .json or .jsonl files as a single JSONL stream.</p>
<p>A handy utility for consolidating data. It reads all files ending in <code>.json</code>
or <code>.jsonl</code> from a specified directory and yields each JSON object as a
separate line. This is perfect for preparing a dataset that has been
stored as many small files.</p>
<ul>
<li>For <code>.json</code> files, the entire file is treated as a single JSON object.</li>
<li>For <code>.jsonl</code> files, each line is treated as a separate JSON object.</li>
</ul>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dir_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The path to the directory to read.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Yields:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A string for each JSON object found, ready for processing.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>ja/importer.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span>
<span class="normal">69</span>
<span class="normal">70</span>
<span class="normal">71</span>
<span class="normal">72</span>
<span class="normal">73</span>
<span class="normal">74</span>
<span class="normal">75</span>
<span class="normal">76</span>
<span class="normal">77</span>
<span class="normal">78</span>
<span class="normal">79</span>
<span class="normal">80</span>
<span class="normal">81</span>
<span class="normal">82</span>
<span class="normal">83</span>
<span class="normal">84</span>
<span class="normal">85</span>
<span class="normal">86</span>
<span class="normal">87</span>
<span class="normal">88</span>
<span class="normal">89</span>
<span class="normal">90</span>
<span class="normal">91</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">dir_to_jsonl_lines</span><span class="p">(</span><span class="n">dir_path</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Stream a directory of .json or .jsonl files as a single JSONL stream.</span>

<span class="sd">    A handy utility for consolidating data. It reads all files ending in `.json`</span>
<span class="sd">    or `.jsonl` from a specified directory and yields each JSON object as a</span>
<span class="sd">    separate line. This is perfect for preparing a dataset that has been</span>
<span class="sd">    stored as many small files.</span>

<span class="sd">    - For `.json` files, the entire file is treated as a single JSON object.</span>
<span class="sd">    - For `.jsonl` files, each line is treated as a separate JSON object.</span>

<span class="sd">    Args:</span>
<span class="sd">        dir_path (str): The path to the directory to read.</span>

<span class="sd">    Yields:</span>
<span class="sd">        A string for each JSON object found, ready for processing.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">filename</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">dir_path</span><span class="p">)):</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">dir_path</span><span class="p">,</span> <span class="n">filename</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">yield</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">IOError</span><span class="p">,</span> <span class="n">json</span><span class="o">.</span><span class="n">JSONDecodeError</span><span class="p">)</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading or parsing </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">filename</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.jsonl&quot;</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">f</span><span class="p">:</span>
                        <span class="k">yield</span> <span class="n">line</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">IOError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error reading </span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">file</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.schema" class="doc doc-heading">
            <code>ja.schema</code>


</h2>

    <div class="doc doc-contents first">

        <p>Discover the structure of your data automatically.</p>
<p>This module provides powerful tools to infer a JSON Schema from your JSONL files.
A schema acts as a blueprint for your data, describing its fields, types, and
which fields are required. This is incredibly useful for validation, documentation,
and ensuring data quality.</p>









  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h3 id="ja.schema.add_required_fields" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">add_required_fields</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">data_samples</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Refine a schema by identifying which fields are always present.</p>
<p>This function analyzes a list of data samples and updates the schema to mark
fields as 'required' if they appear in every single sample. This process is
applied recursively to nested objects, making the resulting schema more precise.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>schema</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The schema dictionary to modify in place.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>data_samples</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of data samples to analyze for required fields.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <p>If all samples in <code>data_samples</code> have 'name' and 'age' fields, this
function adds <code>{"required": ["age", "name"]}</code> to the schema.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>ja/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">add_required_fields</span><span class="p">(</span><span class="n">schema</span><span class="p">,</span> <span class="n">data_samples</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Refine a schema by identifying which fields are always present.</span>

<span class="sd">    This function analyzes a list of data samples and updates the schema to mark</span>
<span class="sd">    fields as &#39;required&#39; if they appear in every single sample. This process is</span>
<span class="sd">    applied recursively to nested objects, making the resulting schema more precise.</span>

<span class="sd">    Args:</span>
<span class="sd">        schema: The schema dictionary to modify in place.</span>
<span class="sd">        data_samples: A list of data samples to analyze for required fields.</span>

<span class="sd">    Example:</span>
<span class="sd">        If all samples in `data_samples` have &#39;name&#39; and &#39;age&#39; fields, this</span>
<span class="sd">        function adds `{&quot;required&quot;: [&quot;age&quot;, &quot;name&quot;]}` to the schema.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span> <span class="ow">and</span> <span class="s2">&quot;properties&quot;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="c1"># For object schemas, find fields present in all samples</span>
        <span class="n">dict_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">data_samples</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)]</span>
        <span class="k">if</span> <span class="n">dict_samples</span><span class="p">:</span>
            <span class="n">required_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">dict_samples</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">dict_samples</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="n">required_keys</span><span class="o">.</span><span class="n">intersection_update</span><span class="p">(</span><span class="n">sample</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
            <span class="k">if</span> <span class="n">required_keys</span><span class="p">:</span>
                <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;required&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">required_keys</span><span class="p">))</span>

        <span class="c1"># Recursively add required fields to nested object properties</span>
        <span class="k">for</span> <span class="n">prop_name</span><span class="p">,</span> <span class="n">prop_schema</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">prop_samples</span> <span class="o">=</span> <span class="p">[</span><span class="n">s</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">prop_name</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">dict_samples</span> <span class="k">if</span> <span class="n">prop_name</span> <span class="ow">in</span> <span class="n">s</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">prop_samples</span><span class="p">:</span>
                <span class="n">add_required_fields</span><span class="p">(</span><span class="n">prop_schema</span><span class="p">,</span> <span class="n">prop_samples</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">schema</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span> <span class="ow">and</span> <span class="s2">&quot;items&quot;</span> <span class="ow">in</span> <span class="n">schema</span><span class="p">:</span>
        <span class="c1"># For array schemas, collect all array items and add required fields</span>
        <span class="n">array_items</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sample</span> <span class="ow">in</span> <span class="n">data_samples</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sample</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="n">array_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">sample</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">array_items</span><span class="p">:</span>
            <span class="n">add_required_fields</span><span class="p">(</span><span class="n">schema</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">],</span> <span class="n">array_items</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.schema.get_json_type" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_json_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Determine the appropriate JSON Schema type for a given Python value.</p>
<p>Maps Python types to their corresponding JSON Schema type names.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Any Python value.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The JSON Schema type name as a string.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>get_json_type("hello")
'string'
get_json_type(42)
'integer'</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>ja/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span>
<span class="normal">19</span>
<span class="normal">20</span>
<span class="normal">21</span>
<span class="normal">22</span>
<span class="normal">23</span>
<span class="normal">24</span>
<span class="normal">25</span>
<span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_json_type</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Determine the appropriate JSON Schema type for a given Python value.</span>

<span class="sd">    Maps Python types to their corresponding JSON Schema type names.</span>

<span class="sd">    Args:</span>
<span class="sd">        value: Any Python value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        The JSON Schema type name as a string.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; get_json_type(&quot;hello&quot;)</span>
<span class="sd">        &#39;string&#39;</span>
<span class="sd">        &gt;&gt;&gt; get_json_type(42)</span>
<span class="sd">        &#39;integer&#39;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;string&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">bool</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;boolean&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;integer&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">float</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;number&quot;</span>
    <span class="k">if</span> <span class="n">value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;null&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;array&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">return</span> <span class="s2">&quot;object&quot;</span>
    <span class="k">return</span> <span class="s2">&quot;unknown&quot;</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.schema.infer_schema" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">infer_schema</span><span class="p">(</span><span class="n">data</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Infer a complete JSON schema from a collection of data records.</p>
<p>This is the main entry point for schema inference. Give it an iterable of
JSON objects (like a list of dictionaries), and it will return a complete
JSON Schema that describes the entire dataset. It automatically handles
varying fields, mixed types, nested structures, and identifies required fields.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>data</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An iterable of data records (typically dictionaries).</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A JSON schema dictionary with <code>$schema</code>, type, properties, and required fields.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>data = [{"name": "Alice", "age": 30}, {"name": "Bob", "age": 25}]
schema = infer_schema(data)
schema["properties"]["name"]
{'type': 'string'}
schema["required"]['age', 'name']</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>ja/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">infer_schema</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer a complete JSON schema from a collection of data records.</span>

<span class="sd">    This is the main entry point for schema inference. Give it an iterable of</span>
<span class="sd">    JSON objects (like a list of dictionaries), and it will return a complete</span>
<span class="sd">    JSON Schema that describes the entire dataset. It automatically handles</span>
<span class="sd">    varying fields, mixed types, nested structures, and identifies required fields.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: An iterable of data records (typically dictionaries).</span>

<span class="sd">    Returns:</span>
<span class="sd">        A JSON schema dictionary with `$schema`, type, properties, and required fields.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; data = [{&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30}, {&quot;name&quot;: &quot;Bob&quot;, &quot;age&quot;: 25}]</span>
<span class="sd">        &gt;&gt;&gt; schema = infer_schema(data)</span>
<span class="sd">        &gt;&gt;&gt; schema[&quot;properties&quot;][&quot;name&quot;]</span>
<span class="sd">        {&#39;type&#39;: &#39;string&#39;}</span>
<span class="sd">        &gt;&gt;&gt; schema[&quot;required&quot;]</span>
<span class="sd">        [&#39;age&#39;, &#39;name&#39;]</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">records</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">records</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft-07/schema#&quot;</span><span class="p">,</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span>
        <span class="p">}</span>

    <span class="c1"># Infer schema for each record</span>
    <span class="n">inferred_schemas</span> <span class="o">=</span> <span class="p">[</span><span class="n">infer_value_schema</span><span class="p">(</span><span class="n">rec</span><span class="p">)</span> <span class="k">for</span> <span class="n">rec</span> <span class="ow">in</span> <span class="n">records</span><span class="p">]</span>

    <span class="c1"># Merge all inferred schemas</span>
    <span class="n">merged_schema</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">inferred_schemas</span><span class="p">:</span>
        <span class="n">merged_schema</span> <span class="o">=</span> <span class="n">merge_schemas</span><span class="p">(</span><span class="n">merged_schema</span><span class="p">,</span> <span class="n">s</span><span class="p">)</span>

    <span class="c1"># Add required fields recursively</span>
    <span class="k">if</span> <span class="n">merged_schema</span><span class="p">:</span>
        <span class="n">add_required_fields</span><span class="p">(</span><span class="n">merged_schema</span><span class="p">,</span> <span class="n">records</span><span class="p">)</span>

    <span class="c1"># Add the meta-schema URL</span>
    <span class="n">final_schema</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;$schema&quot;</span><span class="p">:</span> <span class="s2">&quot;http://json-schema.org/draft-07/schema#&quot;</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">merged_schema</span><span class="p">:</span>
        <span class="n">final_schema</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">merged_schema</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">final_schema</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.schema.infer_value_schema" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">infer_value_schema</span><span class="p">(</span><span class="n">value</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Infer a JSON Schema for a single Python value.</p>
<p>Creates a schema that describes the structure and type of the given value,
handling nested objects and arrays recursively.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>value</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Any JSON-serializable Python value.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A JSON schema dictionary describing the value.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>infer_value_schema({"name": "Alice", "age": 30})
{'type': 'object', 'properties': {'name': {'type': 'string'}, 'age': {'type': 'integer'}}}</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>ja/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">infer_value_schema</span><span class="p">(</span><span class="n">value</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Infer a JSON Schema for a single Python value.</span>

<span class="sd">    Creates a schema that describes the structure and type of the given value,</span>
<span class="sd">    handling nested objects and arrays recursively.</span>

<span class="sd">    Args:</span>
<span class="sd">        value: Any JSON-serializable Python value.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A JSON schema dictionary describing the value.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; infer_value_schema({&quot;name&quot;: &quot;Alice&quot;, &quot;age&quot;: 30})</span>
<span class="sd">        {&#39;type&#39;: &#39;object&#39;, &#39;properties&#39;: {&#39;name&#39;: {&#39;type&#39;: &#39;string&#39;}, &#39;age&#39;: {&#39;type&#39;: &#39;integer&#39;}}}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">type_name</span> <span class="o">=</span> <span class="n">get_json_type</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
    <span class="n">schema</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">type_name</span><span class="p">}</span>
    <span class="k">if</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s2">&quot;object&quot;</span><span class="p">:</span>
        <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">infer_value_schema</span><span class="p">(</span><span class="n">v</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">value</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
    <span class="k">elif</span> <span class="n">type_name</span> <span class="o">==</span> <span class="s2">&quot;array&quot;</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">value</span><span class="p">:</span>
            <span class="n">item_schema</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">value</span><span class="p">:</span>
                <span class="n">item_schema</span> <span class="o">=</span> <span class="n">merge_schemas</span><span class="p">(</span><span class="n">item_schema</span><span class="p">,</span> <span class="n">infer_value_schema</span><span class="p">(</span><span class="n">item</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">item_schema</span><span class="p">:</span>
                <span class="n">schema</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_schema</span>
    <span class="k">return</span> <span class="n">schema</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h3 id="ja.schema.merge_schemas" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">merge_schemas</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">)</span></code>

</h3>


    <div class="doc doc-contents ">

        <p>Intelligently merge two JSON schemas into one.</p>
<p>This is the secret sauce that allows schema inference to work across many
different JSON objects, even if they have different fields or types. It handles
type unions (e.g., a field that is sometimes a string, sometimes an integer)
and recursively merges nested object properties and array item schemas.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>s1</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>First JSON schema dictionary or None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>s2</code>
            </td>
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Second JSON schema dictionary or None.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A merged schema dictionary combining both inputs.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="example" open>
  <summary>Example</summary>
  <blockquote>
<blockquote>
<blockquote>
<p>s1 = {"type": "string"}
s2 = {"type": "integer"}
merge_schemas(s1, s2)
{'type': ['integer', 'string']}</p>
</blockquote>
</blockquote>
</blockquote>
</details>

            <details class="quote">
              <summary>Source code in <code>ja/schema.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">merge_schemas</span><span class="p">(</span><span class="n">s1</span><span class="p">,</span> <span class="n">s2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Intelligently merge two JSON schemas into one.</span>

<span class="sd">    This is the secret sauce that allows schema inference to work across many</span>
<span class="sd">    different JSON objects, even if they have different fields or types. It handles</span>
<span class="sd">    type unions (e.g., a field that is sometimes a string, sometimes an integer)</span>
<span class="sd">    and recursively merges nested object properties and array item schemas.</span>

<span class="sd">    Args:</span>
<span class="sd">        s1: First JSON schema dictionary or None.</span>
<span class="sd">        s2: Second JSON schema dictionary or None.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A merged schema dictionary combining both inputs.</span>

<span class="sd">    Example:</span>
<span class="sd">        &gt;&gt;&gt; s1 = {&quot;type&quot;: &quot;string&quot;}</span>
<span class="sd">        &gt;&gt;&gt; s2 = {&quot;type&quot;: &quot;integer&quot;}</span>
<span class="sd">        &gt;&gt;&gt; merge_schemas(s1, s2)</span>
<span class="sd">        {&#39;type&#39;: [&#39;integer&#39;, &#39;string&#39;]}</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">s1</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s2</span>
    <span class="k">if</span> <span class="n">s2</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s1</span>
    <span class="k">if</span> <span class="n">s1</span> <span class="o">==</span> <span class="n">s2</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">s1</span>

    <span class="c1"># Merge types</span>
    <span class="n">type1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type1</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">type1</span> <span class="o">=</span> <span class="p">[</span><span class="n">type1</span><span class="p">]</span>
    <span class="n">type2</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">type2</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="n">type2</span> <span class="o">=</span> <span class="p">[</span><span class="n">type2</span><span class="p">]</span>

    <span class="n">merged_types</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">type1</span><span class="p">)</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">type2</span><span class="p">)))</span>
    <span class="k">if</span> <span class="s2">&quot;integer&quot;</span> <span class="ow">in</span> <span class="n">merged_types</span> <span class="ow">and</span> <span class="s2">&quot;number&quot;</span> <span class="ow">in</span> <span class="n">merged_types</span><span class="p">:</span>
        <span class="n">merged_types</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="s2">&quot;integer&quot;</span><span class="p">)</span>

    <span class="n">merged_schema</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_types</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">merged_schema</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">merged_schema</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_types</span>

    <span class="c1"># If both schemas could be objects, merge properties</span>
    <span class="k">if</span> <span class="s2">&quot;object&quot;</span> <span class="ow">in</span> <span class="n">type1</span> <span class="ow">and</span> <span class="s2">&quot;object&quot;</span> <span class="ow">in</span> <span class="n">type2</span><span class="p">:</span>
        <span class="n">props1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">props2</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;properties&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">all_keys</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">props1</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span> <span class="o">|</span> <span class="nb">set</span><span class="p">(</span><span class="n">props2</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">merged_props</span> <span class="o">=</span> <span class="p">{</span>
            <span class="n">key</span><span class="p">:</span> <span class="n">merge_schemas</span><span class="p">(</span><span class="n">props1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">),</span> <span class="n">props2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">key</span><span class="p">))</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">all_keys</span>
        <span class="p">}</span>
        <span class="k">if</span> <span class="n">merged_props</span><span class="p">:</span>
            <span class="n">merged_schema</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_props</span>

    <span class="c1"># If both schemas could be arrays, merge items</span>
    <span class="k">if</span> <span class="s2">&quot;array&quot;</span> <span class="ow">in</span> <span class="n">type1</span> <span class="ow">and</span> <span class="s2">&quot;array&quot;</span> <span class="ow">in</span> <span class="n">type2</span><span class="p">:</span>
        <span class="n">items1</span> <span class="o">=</span> <span class="n">s1</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">)</span>
        <span class="n">items2</span> <span class="o">=</span> <span class="n">s2</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;items&quot;</span><span class="p">)</span>
        <span class="n">merged_items</span> <span class="o">=</span> <span class="n">merge_schemas</span><span class="p">(</span><span class="n">items1</span><span class="p">,</span> <span class="n">items2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">merged_items</span><span class="p">:</span>
            <span class="n">merged_schema</span><span class="p">[</span><span class="s2">&quot;items&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">merged_items</span>

    <span class="k">return</span> <span class="n">merged_schema</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>

<div class="doc doc-object doc-module">



<h2 id="ja.expr" class="doc doc-heading">
            <code>ja.expr</code>


</h2>

    <div class="doc doc-contents first">

        <p>Expression parser for ja commands.</p>
<p>This module provides a lightweight expression parser that allows intuitive
syntax without quotes for most common cases.</p>









  <div class="doc doc-children">








<div class="doc doc-object doc-class">



<h3 id="ja.expr.ExprEval" class="doc doc-heading">
            <code>ExprEval</code>


</h3>


    <div class="doc doc-contents ">


        <p>Parse and evaluate expressions for filtering, comparison, and arithmetic.</p>







              <details class="quote">
                <summary>Source code in <code>ja/expr.py</code></summary>
                <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 12</span>
<span class="normal"> 13</span>
<span class="normal"> 14</span>
<span class="normal"> 15</span>
<span class="normal"> 16</span>
<span class="normal"> 17</span>
<span class="normal"> 18</span>
<span class="normal"> 19</span>
<span class="normal"> 20</span>
<span class="normal"> 21</span>
<span class="normal"> 22</span>
<span class="normal"> 23</span>
<span class="normal"> 24</span>
<span class="normal"> 25</span>
<span class="normal"> 26</span>
<span class="normal"> 27</span>
<span class="normal"> 28</span>
<span class="normal"> 29</span>
<span class="normal"> 30</span>
<span class="normal"> 31</span>
<span class="normal"> 32</span>
<span class="normal"> 33</span>
<span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span><span class="w"> </span><span class="nc">ExprEval</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and evaluate expressions for filtering, comparison, and arithmetic.&quot;&quot;&quot;</span>

    <span class="k">def</span><span class="w"> </span><span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Operators in precedence order (longest first to handle &gt;= before &gt;)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">operators</span> <span class="o">=</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;==&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">eq</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;!=&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">ne</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;&gt;=&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">ge</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;&lt;=&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">le</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;&gt;&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">gt</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;&lt;&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">lt</span><span class="p">),</span>
        <span class="p">]</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">parse_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse a value string into appropriate Python type.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &quot;123&quot; -&gt; 123</span>
<span class="sd">            &quot;12.5&quot; -&gt; 12.5</span>
<span class="sd">            &quot;true&quot; -&gt; True</span>
<span class="sd">            &quot;false&quot; -&gt; False</span>
<span class="sd">            &quot;null&quot; -&gt; None</span>
<span class="sd">            &quot;active&quot; -&gt; &quot;active&quot; (string)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">value_str</span> <span class="o">=</span> <span class="n">value_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Empty string</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">value_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># Boolean literals (case-insensitive)</span>
        <span class="k">if</span> <span class="n">value_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="n">value_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Null literal</span>
        <span class="k">if</span> <span class="n">value_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Numbers</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">value_str</span><span class="p">:</span>
                <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
            <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="c1"># Quoted strings (remove quotes)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">value_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
            <span class="n">value_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">return</span> <span class="n">value_str</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Unquoted strings (the nice default!)</span>
        <span class="k">return</span> <span class="n">value_str</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">get_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">field_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get value from nested object using dot notation.</span>

<span class="sd">        Examples:</span>
<span class="sd">            get_field_value({&quot;user&quot;: {&quot;name&quot;: &quot;Alice&quot;}}, &quot;user.name&quot;) -&gt; &quot;Alice&quot;</span>
<span class="sd">            get_field_value({&quot;items&quot;: [{&quot;id&quot;: 1}]}, &quot;items[0].id&quot;) -&gt; 1</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_path</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">obj</span>

        <span class="n">current</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="c1"># Handle array indexing and dots</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.|\[|\]&quot;</span><span class="p">,</span> <span class="n">field_path</span><span class="p">)</span>
        <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>  <span class="c1"># Remove empty strings</span>

        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

            <span class="c1"># Try as dict key</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
            <span class="c1"># Try as array index</span>
            <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
                    <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">current</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">set_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">field_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set value in nested object using dot notation.&quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">field_path</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="n">parts</span> <span class="o">=</span> <span class="n">field_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">obj</span>

        <span class="c1"># Navigate to the parent of the target field</span>
        <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span><span class="p">:</span>
                <span class="n">current</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>

        <span class="c1"># Set the value</span>
        <span class="n">current</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">op_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate a comparison operation.&quot;&quot;&quot;</span>
        <span class="n">op_func</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">op_str</span><span class="p">:</span>
                <span class="n">op_func</span> <span class="o">=</span> <span class="n">func</span>
                <span class="k">break</span>

        <span class="k">if</span> <span class="n">op_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown operator: </span><span class="si">{</span><span class="n">op_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Special handling for null comparisons</span>
        <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op_str</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">left</span> <span class="o">==</span> <span class="n">right</span>
            <span class="k">elif</span> <span class="n">op_str</span> <span class="o">==</span> <span class="s2">&quot;!=&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">right</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Type coercion for comparison</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">op_func</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="c1"># If comparison fails, try string comparison</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">return</span> <span class="n">op_func</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">right</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">False</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Parse and evaluate an expression.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &quot;status == active&quot;</span>
<span class="sd">            &quot;age &gt; 30&quot;</span>
<span class="sd">            &quot;user.type == premium&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

        <span class="c1"># Empty expression is false</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

        <span class="c1"># Check for operators</span>
        <span class="k">for</span> <span class="n">op_str</span><span class="p">,</span> <span class="n">op_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">op_str</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
                <span class="c1"># Split on the FIRST occurrence of the operator</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">op_str</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">left_expr</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">right_expr</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="c1"># Left side is always a field path</span>
                    <span class="n">left_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">left_expr</span><span class="p">)</span>

                    <span class="c1"># Right side: check if it&#39;s a field or a literal</span>
                    <span class="c1"># A token is a field if it exists as a key in the context</span>
                    <span class="c1"># and is not a boolean/null keyword.</span>
                    <span class="k">if</span> <span class="n">right_expr</span> <span class="ow">in</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">right_expr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]:</span>
                        <span class="c1"># It&#39;s a field reference</span>
                        <span class="n">right_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">right_expr</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># It&#39;s a literal value</span>
                        <span class="n">right_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">right_expr</span><span class="p">)</span>

                    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_comparison</span><span class="p">(</span><span class="n">left_val</span><span class="p">,</span> <span class="n">op_str</span><span class="p">,</span> <span class="n">right_val</span><span class="p">)</span>

        <span class="c1"># No operator found - treat as existence/truthiness check</span>
        <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>

    <span class="k">def</span><span class="w"> </span><span class="nf">evaluate_arithmetic</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Evaluate simple arithmetic expressions.</span>

<span class="sd">        Examples:</span>
<span class="sd">            &quot;amount * 1.1&quot;</span>
<span class="sd">            &quot;score + bonus&quot;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Simple arithmetic support</span>
        <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">),</span>
            <span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">truediv</span><span class="p">),</span>
        <span class="p">]:</span>
            <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
                <span class="n">parts</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                    <span class="n">left_str</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                    <span class="n">right_str</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                    <span class="c1"># Get left value (field or literal)</span>
                    <span class="n">left_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">left_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">left_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">left_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">left_str</span><span class="p">)</span>

                    <span class="c1"># Get right value (field or literal)</span>
                    <span class="n">right_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">right_str</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">right_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">right_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">right_str</span><span class="p">)</span>

                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">left_val</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">right_val</span><span class="p">))</span>
                    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                        <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># No operator - try as field or literal</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
        <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
              </details>



  <div class="doc doc-children">









<div class="doc doc-object doc-function">


<h4 id="ja.expr.ExprEval.evaluate" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Parse and evaluate an expression.</p>


<p><span class="doc-section-title">Examples:</span></p>
    <p>"status == active"
"age &gt; 30"
"user.type == premium"</p>


            <details class="quote">
              <summary>Source code in <code>ja/expr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse and evaluate an expression.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &quot;status == active&quot;</span>
<span class="sd">        &quot;age &gt; 30&quot;</span>
<span class="sd">        &quot;user.type == premium&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">expr</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Empty expression is false</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">expr</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Check for operators</span>
    <span class="k">for</span> <span class="n">op_str</span><span class="p">,</span> <span class="n">op_func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op_str</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
            <span class="c1"># Split on the FIRST occurrence of the operator</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">op_str</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">left_expr</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">right_expr</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c1"># Left side is always a field path</span>
                <span class="n">left_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">left_expr</span><span class="p">)</span>

                <span class="c1"># Right side: check if it&#39;s a field or a literal</span>
                <span class="c1"># A token is a field if it exists as a key in the context</span>
                <span class="c1"># and is not a boolean/null keyword.</span>
                <span class="k">if</span> <span class="n">right_expr</span> <span class="ow">in</span> <span class="n">context</span> <span class="ow">and</span> <span class="n">right_expr</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;true&#39;</span><span class="p">,</span> <span class="s1">&#39;false&#39;</span><span class="p">,</span> <span class="s1">&#39;null&#39;</span><span class="p">,</span> <span class="s1">&#39;none&#39;</span><span class="p">]:</span>
                    <span class="c1"># It&#39;s a field reference</span>
                    <span class="n">right_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">right_expr</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="c1"># It&#39;s a literal value</span>
                    <span class="n">right_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">right_expr</span><span class="p">)</span>

                <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">evaluate_comparison</span><span class="p">(</span><span class="n">left_val</span><span class="p">,</span> <span class="n">op_str</span><span class="p">,</span> <span class="n">right_val</span><span class="p">)</span>

    <span class="c1"># No operator found - treat as existence/truthiness check</span>
    <span class="n">value</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
    <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">value</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.expr.ExprEval.evaluate_arithmetic" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_arithmetic</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Evaluate simple arithmetic expressions.</p>


<p><span class="doc-section-title">Examples:</span></p>
    <p>"amount * 1.1"
"score + bonus"</p>


            <details class="quote">
              <summary>Source code in <code>ja/expr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_arithmetic</span><span class="p">(</span>
    <span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">context</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">float</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate simple arithmetic expressions.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &quot;amount * 1.1&quot;</span>
<span class="sd">        &quot;score + bonus&quot;</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Simple arithmetic support</span>
    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="p">[</span>
        <span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">mul</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">add</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">sub</span><span class="p">),</span>
        <span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">,</span> <span class="n">operator</span><span class="o">.</span><span class="n">truediv</span><span class="p">),</span>
    <span class="p">]:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="ow">in</span> <span class="n">expr</span><span class="p">:</span>
            <span class="n">parts</span> <span class="o">=</span> <span class="n">expr</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">op</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">parts</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">left_str</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="n">right_str</span> <span class="o">=</span> <span class="n">parts</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

                <span class="c1"># Get left value (field or literal)</span>
                <span class="n">left_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">left_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">left_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">left_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">left_str</span><span class="p">)</span>

                <span class="c1"># Get right value (field or literal)</span>
                <span class="n">right_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">right_str</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">right_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">right_val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">right_str</span><span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="nb">float</span><span class="p">(</span><span class="n">left_val</span><span class="p">),</span> <span class="nb">float</span><span class="p">(</span><span class="n">right_val</span><span class="p">))</span>
                <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
                    <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># No operator - try as field or literal</span>
    <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_field_value</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">expr</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">val</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">parse_value</span><span class="p">(</span><span class="n">expr</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">val</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.expr.ExprEval.evaluate_comparison" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">evaluate_comparison</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">op_str</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Evaluate a comparison operation.</p>


            <details class="quote">
              <summary>Source code in <code>ja/expr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">evaluate_comparison</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">left</span><span class="p">:</span> <span class="n">Any</span><span class="p">,</span> <span class="n">op_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">right</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Evaluate a comparison operation.&quot;&quot;&quot;</span>
    <span class="n">op_func</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="k">for</span> <span class="n">op</span><span class="p">,</span> <span class="n">func</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">operators</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op</span> <span class="o">==</span> <span class="n">op_str</span><span class="p">:</span>
            <span class="n">op_func</span> <span class="o">=</span> <span class="n">func</span>
            <span class="k">break</span>

    <span class="k">if</span> <span class="n">op_func</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unknown operator: </span><span class="si">{</span><span class="n">op_str</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Special handling for null comparisons</span>
    <span class="k">if</span> <span class="n">left</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">right</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">op_str</span> <span class="o">==</span> <span class="s2">&quot;==&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">left</span> <span class="o">==</span> <span class="n">right</span>
        <span class="k">elif</span> <span class="n">op_str</span> <span class="o">==</span> <span class="s2">&quot;!=&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">right</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Type coercion for comparison</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">op_func</span><span class="p">(</span><span class="n">left</span><span class="p">,</span> <span class="n">right</span><span class="p">)</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="c1"># If comparison fails, try string comparison</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">op_func</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">left</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">right</span><span class="p">))</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">False</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.expr.ExprEval.get_field_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">get_field_value</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_path</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Get value from nested object using dot notation.</p>


<p><span class="doc-section-title">Examples:</span></p>
    <p>get_field_value({"user": {"name": "Alice"}}, "user.name") -&gt; "Alice"
get_field_value({"items": [{"id": 1}]}, "items[0].id") -&gt; 1</p>


            <details class="quote">
              <summary>Source code in <code>ja/expr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">get_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">field_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get value from nested object using dot notation.</span>

<span class="sd">    Examples:</span>
<span class="sd">        get_field_value({&quot;user&quot;: {&quot;name&quot;: &quot;Alice&quot;}}, &quot;user.name&quot;) -&gt; &quot;Alice&quot;</span>
<span class="sd">        get_field_value({&quot;items&quot;: [{&quot;id&quot;: 1}]}, &quot;items[0].id&quot;) -&gt; 1</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">field_path</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">obj</span>

    <span class="n">current</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="c1"># Handle array indexing and dots</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\.|\[|\]&quot;</span><span class="p">,</span> <span class="n">field_path</span><span class="p">)</span>
    <span class="n">parts</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parts</span> <span class="k">if</span> <span class="n">p</span><span class="p">]</span>  <span class="c1"># Remove empty strings</span>

    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">current</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="c1"># Try as dict key</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
        <span class="c1"># Try as array index</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">current</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">idx</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">part</span><span class="p">)</span>
                <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="n">idx</span><span class="p">]</span> <span class="k">if</span> <span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">current</span><span class="p">)</span> <span class="k">else</span> <span class="kc">None</span>
            <span class="k">except</span> <span class="p">(</span><span class="ne">ValueError</span><span class="p">,</span> <span class="ne">IndexError</span><span class="p">):</span>
                <span class="k">return</span> <span class="kc">None</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

    <span class="k">return</span> <span class="n">current</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.expr.ExprEval.parse_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">parse_value</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Parse a value string into appropriate Python type.</p>


<p><span class="doc-section-title">Examples:</span></p>
    <p>"123" -&gt; 123
"12.5" -&gt; 12.5
"true" -&gt; True
"false" -&gt; False
"null" -&gt; None
"active" -&gt; "active" (string)</p>


            <details class="quote">
              <summary>Source code in <code>ja/expr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">26</span>
<span class="normal">27</span>
<span class="normal">28</span>
<span class="normal">29</span>
<span class="normal">30</span>
<span class="normal">31</span>
<span class="normal">32</span>
<span class="normal">33</span>
<span class="normal">34</span>
<span class="normal">35</span>
<span class="normal">36</span>
<span class="normal">37</span>
<span class="normal">38</span>
<span class="normal">39</span>
<span class="normal">40</span>
<span class="normal">41</span>
<span class="normal">42</span>
<span class="normal">43</span>
<span class="normal">44</span>
<span class="normal">45</span>
<span class="normal">46</span>
<span class="normal">47</span>
<span class="normal">48</span>
<span class="normal">49</span>
<span class="normal">50</span>
<span class="normal">51</span>
<span class="normal">52</span>
<span class="normal">53</span>
<span class="normal">54</span>
<span class="normal">55</span>
<span class="normal">56</span>
<span class="normal">57</span>
<span class="normal">58</span>
<span class="normal">59</span>
<span class="normal">60</span>
<span class="normal">61</span>
<span class="normal">62</span>
<span class="normal">63</span>
<span class="normal">64</span>
<span class="normal">65</span>
<span class="normal">66</span>
<span class="normal">67</span>
<span class="normal">68</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">parse_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">value_str</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Any</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Parse a value string into appropriate Python type.</span>

<span class="sd">    Examples:</span>
<span class="sd">        &quot;123&quot; -&gt; 123</span>
<span class="sd">        &quot;12.5&quot; -&gt; 12.5</span>
<span class="sd">        &quot;true&quot; -&gt; True</span>
<span class="sd">        &quot;false&quot; -&gt; False</span>
<span class="sd">        &quot;null&quot; -&gt; None</span>
<span class="sd">        &quot;active&quot; -&gt; &quot;active&quot; (string)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">value_str</span> <span class="o">=</span> <span class="n">value_str</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>

    <span class="c1"># Empty string</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">value_str</span><span class="p">:</span>
        <span class="k">return</span> <span class="s2">&quot;&quot;</span>

    <span class="c1"># Boolean literals (case-insensitive)</span>
    <span class="k">if</span> <span class="n">value_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;true&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">value_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;false&quot;</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="c1"># Null literal</span>
    <span class="k">if</span> <span class="n">value_str</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;null&quot;</span><span class="p">,</span> <span class="s2">&quot;none&quot;</span><span class="p">):</span>
        <span class="k">return</span> <span class="kc">None</span>

    <span class="c1"># Numbers</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;.&quot;</span> <span class="ow">in</span> <span class="n">value_str</span><span class="p">:</span>
            <span class="k">return</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_str</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="c1"># Quoted strings (remove quotes)</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s1">&#39;&quot;&#39;</span><span class="p">))</span> <span class="ow">or</span> <span class="p">(</span>
        <span class="n">value_str</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">value_str</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">return</span> <span class="n">value_str</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="c1"># Unquoted strings (the nice default!)</span>
    <span class="k">return</span> <span class="n">value_str</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">


<h4 id="ja.expr.ExprEval.set_field_value" class="doc doc-heading">
            <code class="highlight language-python"><span class="n">set_field_value</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="n">field_path</span><span class="p">,</span> <span class="n">value</span><span class="p">)</span></code>

</h4>


    <div class="doc doc-contents ">

        <p>Set value in nested object using dot notation.</p>


            <details class="quote">
              <summary>Source code in <code>ja/expr.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">set_field_value</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">obj</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">],</span> <span class="n">field_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">value</span><span class="p">:</span> <span class="n">Any</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Set value in nested object using dot notation.&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">field_path</span><span class="p">:</span>
        <span class="k">return</span>

    <span class="n">parts</span> <span class="o">=</span> <span class="n">field_path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
    <span class="n">current</span> <span class="o">=</span> <span class="n">obj</span>

    <span class="c1"># Navigate to the parent of the target field</span>
    <span class="k">for</span> <span class="n">part</span> <span class="ow">in</span> <span class="n">parts</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]:</span>
        <span class="k">if</span> <span class="n">part</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">current</span><span class="p">:</span>
            <span class="n">current</span><span class="p">[</span><span class="n">part</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">current</span> <span class="o">=</span> <span class="n">current</span><span class="p">[</span><span class="n">part</span><span class="p">]</span>

    <span class="c1"># Set the value</span>
    <span class="n">current</span><span class="p">[</span><span class="n">parts</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]]</span> <span class="o">=</span> <span class="n">value</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>



  </div>

    </div>

</div>




  </div>

    </div>

</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.tabs", "navigation.sections", "navigation.expand", "navigation.top", "search.highlight", "search.share"], "search": "../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.92b07e13.min.js"></script>
      
    
  </body>
</html>